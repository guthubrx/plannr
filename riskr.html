<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riskr - Analyse de Risques Interactive</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Bibliothèques d'export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            padding: 20px;
            color: #1d1d1f;
            line-height: 1.5;
        }
        
        .container {
            width: 98%;
            max-width: none;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.02);
            position: relative;
        }
        
        /* Header avec icône, titre et contrôles */
        .app-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            position: relative;
        }

        .app-icon {
            width: 64px;
            height: 64px;
            opacity: 0.9;
            flex-shrink: 0;
        }

        .app-title-section {
            flex: 1;
            min-width: 0;
        }

        .app-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-shrink: 0;
        }

        h1 {
            color: #1d1d1f;
            margin: 0;
            font-size: 28px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }
        
        h2 {
            color: #1d1d1f;
            margin: 16px 0 12px 0;
            font-size: 22px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }
        
        h3 {
            color: #1d1d1f;
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 16px;
        }
        
        .risk-item {
            background: #f5f5f7;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #e5e5e7;
            transition: border-color 0.2s ease;
        }

        .risk-item:hover {
            border-color: #d2d2d7;
        }
        
        .risk-group {
            margin-bottom: 16px;
        }
        
        .risk-group-header {
            background: #f5f5f7;
            color: #1d1d1f;
            padding: 12px 20px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 16px;
            border: 1px solid #e5e5e7;
        }
        
        .risk-group-number {
            background: #0071e3;
            color: white;
            font-weight: 600;
            font-size: 18px;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .risk-group-title {
            font-size: 20px;
            font-weight: 600;
            color: #1d1d1f;
        }

        .risk-group-description {
            font-size: 16px;
            color: #5a5a5f;
            margin-top: 4px;
        }

        /* Style pour l'édition inline des descriptions de groupes */
        .editable-group-description {
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 4px;
            padding: 4px 8px;
            margin-left: -8px;
            display: inline-block;
            position: relative;
        }

        .editable-group-description:hover {
            background: rgba(255, 255, 255, 0.15);
            outline: 1px dashed rgba(255, 255, 255, 0.4);
        }

        .editable-group-description:focus {
            outline: 2px solid #0071e3;
            background: #ffffff;
            cursor: text;
            color: #1d1d1f;
        }

        .editable-group-description::after {
            content: "";
            opacity: 0;
            margin-left: 0;
            font-size: 0.7em;
            transition: opacity 0.2s ease;
        }

        .editable-group-description:hover::after {
            opacity: 0;
        }

        /* Style pour l'édition inline des noms de risques */
        .editable-risk-title {
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 4px;
            padding: 4px 8px;
            margin: -4px -8px;
            display: inline-block;
            position: relative;
        }

        .editable-risk-title:hover {
            background: rgba(0, 113, 227, 0.05);
            outline: 1px dashed rgba(0, 113, 227, 0.3);
        }

        .editable-risk-title:focus {
            outline: 2px solid #0071e3;
            background: #ffffff;
            cursor: text;
        }

        .editable-risk-title::after {
            content: "";
            opacity: 0;
            margin-left: 0;
            font-size: 0.7em;
            transition: opacity 0.2s ease;
        }

        .editable-risk-title:hover::after {
            opacity: 0;
        }

        /* Style pour les remédiations éditables */
        .editable-remediation {
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 4px;
            padding: 4px 8px;
            margin: -4px -8px;
            display: inline-block;
            position: relative;
        }

        .editable-remediation:hover {
            background: rgba(0, 113, 227, 0.05);
            outline: 1px dashed rgba(0, 113, 227, 0.3);
        }

        .editable-remediation:focus {
            outline: 2px solid #0071e3;
            background: #ffffff;
            cursor: text;
        }

        .editable-remediation::after {
            content: "";
            opacity: 0;
            margin-left: 0;
            font-size: 0.7em;
            transition: opacity 0.2s ease;
        }

        .editable-remediation:hover::after {
            opacity: 0;
        }

        /* Champ Responsable éditable */
        .responsable-cell {
            text-align: center;
            padding: 6px 4px;
        }

        .editable-responsable {
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 4px;
            padding: 4px 8px;
            margin: -4px -8px;
            display: inline-block;
            position: relative;
            min-width: 60px;
            color: #1d1d1f;
        }

        .editable-responsable:hover {
            background: rgba(0, 113, 227, 0.05);
            outline: 1px dashed rgba(0, 113, 227, 0.3);
        }

        .editable-responsable:focus {
            outline: 2px solid #0071e3;
            background: #ffffff;
            cursor: text;
        }

        .editable-responsable::after {
            content: "";
            opacity: 0;
            margin-left: 0;
            font-size: 0.7em;
            transition: opacity 0.2s ease;
        }

        .editable-responsable:hover::after {
            opacity: 0;
        }

        /* Style spécifique pour les headers de groupes collapsables */
        .risk-group-header-collapsible {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 20px;
        }

        .risk-group-header-collapsible .risk-group-number {
            background: #0071e3;
            color: white;
            font-weight: 600;
            font-size: 18px;
            padding: 10px 16px;
            border-radius: 8px;
            min-width: 50px;
            text-align: center;
            flex-shrink: 0;
        }

        .risk-group-header-collapsible > div:last-child {
            flex: 1;
        }

        .risk-group .risk-item {
            margin-left: 0;
            margin-bottom: 16px;
        }

        .risk-group {
            margin-bottom: 16px;
        }
        
        .risk-group-header {
            background: #f5f5f7;
            color: #1d1d1f;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid #e5e5e7;
        }
        
        .risk-group-number {
            background: #0071e3;
            color: white;
            font-weight: 600;
            font-size: 18px;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .risk-group-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .risk-group .risk-item {
            margin-left: 20px;
        }
        
        /* Wrapper de scroll : désactivé par défaut sur desktop */
        .table-scroll-wrapper {
            width: calc(100% - 20px);
            margin-left: 20px;
        }

        /* Nouveau tableau des risques */
        .risks-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 15px;
            background: white;
            table-layout: fixed;
        }

        .risks-table thead {
            background: #f5f5f7;
        }

        .risks-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #1d1d1f;
            border-bottom: 2px solid #d2d2d7;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .risks-table tbody tr:not(.risk-separator-row) {
            border-bottom: 1px solid #e5e5e7;
            transition: all 0.2s ease;
            cursor: move;
            position: relative;
        }

        .risks-table tbody tr:not(.risk-separator-row) td:first-child::before {
            content: "⋮⋮";
            position: absolute;
            left: -20px;
            top: 50%;
            transform: translateY(-50%);
            color: #ccc;
            font-size: 18px;
            letter-spacing: -4px;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
            z-index: 1;
        }

        .risks-table tbody tr:not(.risk-separator-row):hover td:first-child::before {
            opacity: 1;
        }

        .risks-table tbody tr:not(.risk-separator-row) td:first-child {
            position: relative;
        }

        /* Hover sur l'ensemble risque + remédiation */
        .risks-table tbody tr[data-risk-id]:hover,
        .risks-table tbody tr[data-risk-id]:hover + .remediation-row {
            background-color: #f0f4f8 !important;
        }

        .risks-table tbody tr.dragging {
            opacity: 0.5;
            background: #e3f2fd;
        }

        .risks-table tbody tr.drag-over-top {
            border-top: 2px solid #0071e3;
        }

        .risks-table tbody tr.drag-over-bottom {
            border-bottom: 2px solid #0071e3;
        }

        .risks-table td {
            padding: 10px 8px;
            vertical-align: middle;
        }

        .risks-table .risk-title-cell {
            font-weight: 600;
            color: #1d1d1f;
            font-size: 15px;
            position: relative;
        }

        .risks-table .expand-icon {
            display: inline-block;
            width: 20px;
            cursor: pointer;
            user-select: none;
            margin-right: 8px;
            color: #0071e3;
            font-size: 12px;
            transition: transform 0.2s ease;
        }

        .risks-table .expand-icon:hover {
            color: #0051a8;
        }

        .risks-table .remediations-cell {
            color: #555;
            font-size: 14px;
            line-height: 1.6;
        }

        /* Alternance de couleurs : un bloc (risque + remédiation) sur deux */
        .risks-table tbody tr.risk-even {
            background-color: #ffffff;
        }

        .risks-table tbody tr.risk-odd {
            background-color: #f9fafb;
        }

        .risks-table .remediation-row {
            transition: all 0.3s ease;
        }

        .risks-table .remediation-row.collapsed {
            display: none;
        }

        .risks-table .remediation-cell-expanded {
            padding: 12px 20px 16px 20px;
            border-top: 1px solid #e5e5ea;
        }

        .risks-table .remediation-content {
            color: #555;
            font-size: 14px;
            line-height: 1.6;
        }

        .risks-table .remediation-content strong {
            color: #1d1d1f;
            margin-right: 8px;
            font-weight: 600;
        }

        .risks-table .dropdowns-cell {
            text-align: center;
        }

        .risks-table .dropdowns-cell select {
            width: 48%;
            padding: 6px 8px 6px 4px;
            margin: 0 1%;
            border: 1px solid #d2d2d7;
            border-radius: 6px;
            font-size: 13px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2386868b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 4px center;
            background-size: 16px;
        }

        .risks-table .dropdowns-cell select:hover {
            border-color: #0071e3;
            background-color: #f9f9fb;
        }

        .risks-table .dropdowns-cell select:focus {
            outline: none;
            border-color: #0071e3;
            box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.1);
        }

        .risks-table .dropdown-single-cell {
            text-align: center;
            padding: 6px 4px;
        }

        .risks-table .dropdown-single-cell select {
            width: 100%;
            padding: 5px 6px 5px 3px;
            border: 1px solid #d2d2d7;
            border-radius: 6px;
            font-size: 13px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2386868b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 4px center;
            background-size: 16px;
        }

        .risks-table .dropdown-single-cell select:hover {
            border-color: #0071e3;
            background-color: #f9f9fb;
        }

        .risks-table .dropdown-single-cell select:focus {
            outline: none;
            border-color: #0071e3;
            box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.1);
        }

        /* Cellule de statut */
        .risks-table .status-cell {
            text-align: center;
            padding: 6px 4px;
        }

        .risks-table .status-dropdown {
            width: 100%;
            padding: 5px 6px 5px 3px;
            border: 1px solid #d2d2d7;
            border-radius: 6px;
            font-size: 13px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2386868b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 4px center;
            background-size: 16px;
        }

        .risks-table .status-dropdown:hover {
            border-color: #0071e3;
            background-color: #f9f9fb;
        }

        .risks-table .status-dropdown:focus {
            outline: none;
            border-color: #0071e3;
            box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.1);
        }


        /* Matrices sticky en haut */
        .sticky-charts-section {
            position: sticky;
            top: 20px;
            z-index: 100;
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            margin-bottom: 12px;
        }

        /* Nouveau layout : tableau TOUJOURS en dessous des matrices */
        .dashboard-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            align-items: start;
        }

        /* Colonne gauche : matrices côte à côte horizontalement */
        .charts-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* Colonne droite : tableau des groupes */
        .group-table-column {
            display: flex;
            flex-direction: column;
        }

        /* Tableau des groupes en pleine largeur : styles optimisés */
        .group-summary-table .risk-table {
            font-size: 16px;
        }

        .group-summary-table th {
            font-size: 15px;
            padding: 12px 16px;
        }

        .group-summary-table th:first-child {
            width: 90px;
        }

        .group-summary-table th:nth-child(3),
        .group-summary-table th:nth-child(4) {
            width: 100px;
        }

        .group-summary-table td {
            padding: 14px 16px;
        }

        .group-summary-table td:first-child {
            font-size: 14px;
            width: 90px;
        }

        .group-summary-table td:nth-child(3),
        .group-summary-table td:nth-child(4) {
            width: 100px;
        }

        .group-summary-table .criticality-badge {
            font-size: 15px;
            padding: 6px 12px;
        }

        /* Noms de catégories */
        .group-summary-table td > div:first-child {
            font-size: 16px;
        }

        /* Descriptions */
        .group-summary-table td > div:last-child {
            font-size: 16px;
        }

        .chart-wrapper {
            background: white;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #e5e5e7;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .chart-wrapper h3 {
            text-align: center;
            margin-bottom: 8px;
            color: #1d1d1f;
            font-size: 14px;
            font-weight: 600;
            line-height: 1.3;
        }

        .chart-header {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin-bottom: 8px;
        }

        .chart-header h3 {
            margin: 0;
            flex: 1;
        }

        .zoom-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e5e5e7;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            padding: 6px 10px;
            transition: all 0.2s;
            opacity: 0.7;
            z-index: 10;
            backdrop-filter: blur(10px);
        }

        .zoom-btn:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .matrix-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .matrix-modal.active {
            display: flex;
        }

        .matrix-modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 90vw;
            max-height: 90vh;
            position: relative;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }

        .matrix-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 32px;
            cursor: pointer;
            color: #666;
            line-height: 1;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }

        .matrix-modal-close:hover {
            color: #000;
        }

        /* Boutons de navigation dans la modal */
        .matrix-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e5e5e7;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            color: #1d1d1f;
            transition: all 0.2s;
            z-index: 10;
            backdrop-filter: blur(10px);
        }

        .matrix-nav-btn:hover {
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-50%) scale(1.05);
        }

        .matrix-nav-btn.prev {
            left: 30px;
        }

        .matrix-nav-btn.next {
            right: 30px;
        }

        .matrix-modal-canvas {
            width: min(80vh, 70vw);
            aspect-ratio: 1;
            margin: 20px auto 0;
        }

        .matrix-modal-canvas canvas {
            width: 100% !important;
            height: 100% !important;
        }

        #matrix-modal-title {
            text-align: center;
            margin: 0;
            font-size: 20px;
            color: #1d1d1f;
        }

        .chart-canvas {
            position: relative;
            width: min(100%, 50vh);
            aspect-ratio: 1;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chart-canvas canvas {
            width: 100% !important;
            height: 100% !important;
            display: block;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }
        
        .risk-table-container {
            background: white;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #e5e5e7;
            margin-bottom: 12px;
        }
        
        .risk-table-container h3 {
            margin-bottom: 16px;
            color: #1d1d1f;
            font-size: 17px;
            font-weight: 600;
        }
        
        .risk-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 16px;
        }
        
        .risk-table thead {
            background: #f5f5f7;
        }
        
        .risk-table th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #1d1d1f;
            border-bottom: 1px solid #d2d2d7;
            font-size: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .risk-table th:first-child {
            width: 60px;
            text-align: center;
            border-radius: 8px 0 0 0;
        }
        
        .risk-table th:last-child {
            border-radius: 0 8px 0 0;
        }
        
        .risk-table th:nth-child(3),
        .risk-table th:nth-child(4) {
            width: 180px;
            text-align: center;
        }
        
        .risk-table td {
            padding: 14px 16px;
            border-bottom: 1px solid #f5f5f7;
        }
        
        .risk-table tbody tr {
            transition: background-color 0.15s ease;
        }
        
        .risk-table tbody tr:hover {
            background: #fafafa;
        }
        
        .risk-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .risk-table td:first-child {
            font-weight: 600;
            text-align: center;
            color: #1d1d1f;
            font-size: 14px;
        }
        
        .criticality-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 500;
            font-size: 13px;
            letter-spacing: 0.2px;
            white-space: nowrap;
        }
        
        .criticality-low {
            background: #d4f4dd;
            color: #1a6a3e;
        }
        
        .criticality-medium {
            background: #fff4d4;
            color: #8b6914;
        }
        
        .criticality-high {
            background: #ffe1d4;
            color: #a04428;
        }
        
        .criticality-critical {
            background: #ffd4d4;
            color: #a02828;
        }
        
        /* Amélioration du style des groupes */
        .risk-group-description {
            font-size: 14px;
            font-weight: 400;
            color: #5a5a5f;
            margin-top: 4px;
            line-height: 1.4;
        }
        
        /* Responsive : adaptation selon la taille d'écran */

        /* Réduire les paddings sur écrans moyens pour gagner de l'espace */
        @media (max-width: 1400px) {
            .chart-wrapper {
                padding: 10px;
            }

            .chart-wrapper h3 {
                font-size: 13px;
            }
        }

        /* Mobiles et tablettes : adapter le tableau des risques */
        @media (max-width: 900px) {
            .risks-table {
                font-size: 13px;
            }

            .risks-table th,
            .risks-table td {
                padding: 8px;
            }

            .risks-table .dropdowns-cell select {
                width: 45%;
                font-size: 11px;
                padding: 4px 2px;
            }
        }

        /* Tablettes : adapter la grille */
        @media (max-width: 768px) {
            .charts-column {
                grid-template-columns: 1fr;
            }

            .dashboard-layout {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .export-button {
                position: static;
                margin-bottom: 16px;
                width: 100%;
                justify-content: center;
            }

            /* Wrapper du sélecteur de langue en mobile */
            .container > div[style*="position: absolute"][style*="right: 180px"] {
                position: static !important;
                width: 100%;
                margin-bottom: 16px;
            }

            #language-selector {
                position: static !important;
                width: 100%;
            }

            .container {
                width: 98%;
                padding: 15px;
            }

            /* Désactiver sticky sur mobile */
            .sticky-charts-section {
                position: relative !important;
                top: 0 !important;
            }

            .sticky-charts-section.sticky-disabled {
                position: relative !important;
            }

            /* Cacher le toggle sticky sur mobile (pas utile) */
            .sticky-toggle-container {
                display: none;
            }

            /* Réduire la taille des titres */
            h1 {
                font-size: 24px;
            }

            h2 {
                font-size: 20px;
            }

            h3 {
                font-size: 16px;
            }

            /* Tableaux : scroll horizontal */
            .risks-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                margin-left: 0;
                font-size: 13px;
            }

            .risks-table thead,
            .risks-table tbody,
            .risks-table tr {
                display: table;
                width: 100%;
                table-layout: fixed;
            }

            /* Colonnes plus petites sur tablette */
            .risks-table colgroup col:nth-child(1) { width: 20%; }
            .risks-table colgroup col:nth-child(2) { width: 35%; }
            .risks-table colgroup col:nth-child(3) { width: 11.25%; }
            .risks-table colgroup col:nth-child(4) { width: 11.25%; }
            .risks-table colgroup col:nth-child(5) { width: 11.25%; }
            .risks-table colgroup col:nth-child(6) { width: 11.25%; }

            /* Groupes plus compacts */
            .risk-group-header-collapsible {
                font-size: 18px;
                gap: 12px;
            }

            .risk-group-number {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }

            /* Graphiques plus petits */
            .chart-canvas {
                width: min(100%, 40vh);
            }
        }

        /* Mobile paysage et portrait */
        @media (max-width: 600px) {
            .container {
                width: 100%;
                padding: 10px;
                max-width: 100%;
            }

            /* Titres encore plus petits */
            h1 {
                font-size: 20px;
                text-align: center;
            }

            h2 {
                font-size: 18px;
            }

            h3 {
                font-size: 15px;
            }

            /* Sous-titre plus petit et centré */
            #main-subtitle {
                font-size: 13px;
                text-align: center;
            }

            /* Wrapper dédié pour le scroll horizontal des tableaux */
            .table-scroll-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                width: 100%;
                margin-bottom: 8px;
                border: 1px solid #e5e5e7;
                border-radius: 8px;
                position: relative;
            }

            /* Indicateur visuel de scroll */
            .table-scroll-wrapper::after {
                content: '⟶';
                position: sticky;
                right: 0;
                float: right;
                background: rgba(245,245,247,0.95);
                color: #86868b;
                font-size: 16px;
                padding: 8px 12px;
                pointer-events: none;
                opacity: 0.8;
            }

            /* Désactiver le colgroup sur mobile */
            .risks-table colgroup {
                display: none;
            }

            /* Tableaux : forcer une largeur minimale pour scroll */
            .risks-table {
                display: table !important;
                min-width: 750px;
                width: auto;
                font-size: 12px;
                margin-left: 0;
                table-layout: auto !important;
                border: none;
            }

            .risks-table thead,
            .risks-table tbody,
            .risks-table tr {
                display: table-row !important;
            }

            .risks-table th,
            .risks-table td {
                display: table-cell !important;
                padding: 6px 8px;
                white-space: nowrap;
            }

            /* Largeurs minimales pour chaque colonne */
            .risks-table th:nth-child(1),
            .risks-table td:nth-child(1) { min-width: 130px; }

            .risks-table th:nth-child(2),
            .risks-table td:nth-child(2) {
                min-width: 200px;
                max-width: 300px;
                white-space: normal;
            }

            .risks-table th:nth-child(3),
            .risks-table td:nth-child(3),
            .risks-table th:nth-child(4),
            .risks-table td:nth-child(4),
            .risks-table th:nth-child(5),
            .risks-table td:nth-child(5),
            .risks-table th:nth-child(6),
            .risks-table td:nth-child(6) {
                min-width: 110px;
            }

            /* Headers du tableau */
            .risks-table th {
                font-size: 11px;
                white-space: normal;
            }

            /* Dropdowns plus petits et compacts */
            .risks-table select {
                font-size: 11px;
                padding: 4px 6px;
                width: 100%;
                background-position: right 4px center;
                background-size: 12px;
            }

            /* Tableaux récapitulatifs : scroll aussi */
            .risk-table {
                min-width: 600px;
                font-size: 11px;
            }

            .risk-table th,
            .risk-table td {
                padding: 6px 4px;
                font-size: 11px;
            }

            /* Permettre le scroll horizontal pour le tableau récapitulatif */
            .risk-table-container.collapsible-section .collapsible-content {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* Groupes très compacts */
            .risk-group-header-collapsible {
                font-size: 16px;
                gap: 8px;
                flex-wrap: nowrap;
            }

            .risk-group-number {
                width: 28px;
                height: 28px;
                font-size: 14px;
                flex-shrink: 0;
            }

            .risk-group-title {
                font-size: 15px;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .risk-group-description {
                font-size: 12px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            /* Forcer le word-wrap sur les textes longs */
            .editable-risk-title,
            .editable-remediation {
                word-break: break-word;
                overflow-wrap: break-word;
            }

            /* Séparateurs de groupe plus discrets */
            .group-separator {
                margin: 16px 0;
            }

            .group-separator-label {
                font-size: 12px;
                padding: 6px 16px;
            }

            /* Graphiques encore plus petits */
            .chart-canvas {
                width: min(100%, 35vh);
            }

            /* Badges de criticité plus petits */
            .criticality-badge {
                font-size: 11px;
                padding: 3px 8px;
            }

            /* Cacher le drag handle sur mobile */
            .risks-table tbody tr:not(.risk-separator-row) td:first-child::before {
                display: none;
            }
        }

        /* Mobile portrait très petit */
        @media (max-width: 400px) {
            .container {
                padding: 8px;
            }

            h1 {
                font-size: 18px;
            }

            .risks-table {
                font-size: 11px;
                min-width: 550px;
            }

            .risk-group-header-collapsible {
                font-size: 14px;
            }

            /* Icônes plus petites */
            .collapse-icon {
                font-size: 12px;
            }
        }

        /* Styles pour les sections collapsables (pliables) */
        .collapsible-section {
            margin-bottom: 12px;
        }

        /* Retirer le padding/border du container quand c'est une section collapsable */
        .risk-table-container.collapsible-section {
            background: transparent;
            padding: 0;
            border: none;
            border-radius: 0;
        }

        /* La section sticky reste avec son fond et padding */
        .sticky-charts-section.collapsible-section {
            background: white;
            padding: 16px;
        }

        .sticky-charts-section.collapsible-section > .collapsible-content {
            background: transparent;
            padding: 0;
            border: none;
        }

        /* Retirer le margin-bottom du h3 quand c'est un header collapsable */
        .risk-table-container.collapsible-section .collapsible-header {
            margin-bottom: 8px;
        }

        .collapsible-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #f5f5f7;
            border-radius: 8px;
            transition: all 0.2s ease;
            margin-bottom: 8px;
        }

        .collapsible-header:hover {
            background: #e8e8ed;
        }

        .collapse-icon {
            font-size: 14px;
            transition: transform 0.3s ease;
            display: inline-block;
        }

        .collapsible-header.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        /* Appliquer le style de bordure sur le contenu seulement pour les tableaux */
        .risk-table-container.collapsible-section .collapsible-content {
            background: white;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #e5e5e7;
        }

        /* Pour les matrices, appliquer un padding mais pas de border (déjà dans sticky-charts-section) */
        .sticky-charts-section > .collapsible-content {
            padding: 0;
        }

        .sticky-charts-section .collapsible-section:first-child {
            margin-top: 0;
        }

        /* Pour les tableaux dans la sticky section, supprimer le padding indésirable */
        .sticky-charts-section .risk-table-container.collapsible-section .collapsible-content {
            padding: 0;
            background: transparent;
            border: none;
            border-radius: 0;
        }

        /* Pour les groupes de risques, pas de padding/border supplémentaire */
        .risk-group .collapsible-content {
            background: transparent;
            padding: 0;
            border: none;
            margin-top: 8px;
        }

        /* Styles pour l'édition inline du titre et sous-titre */
        .editable-title,
        .editable-subtitle {
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 4px;
            padding: 4px 8px;
            margin-left: -8px;
            position: relative;
        }

        .editable-title:hover,
        .editable-subtitle:hover {
            background: #f5f5f7;
            outline: 1px dashed #d2d2d7;
        }

        .editable-title:focus,
        .editable-subtitle:focus {
            outline: 2px solid #0071e3;
            background: #ffffff;
            cursor: text;
        }

        .editable-title::after,
        .editable-subtitle::after {
            content: "";
            opacity: 0;
            margin-left: 0;
            font-size: 0.7em;
            transition: opacity 0.2s ease;
        }

        .editable-title:hover::after,
        .editable-subtitle:hover::after {
            opacity: 0;
        }

        /* Styles pour l'édition inline des noms de groupes */
        .editable-group-name {
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 4px;
            padding: 4px 8px;
            margin-left: -8px;
            display: inline-block;
            position: relative;
        }

        .editable-group-name:hover {
            background: rgba(255, 255, 255, 0.2);
            outline: 1px dashed rgba(255, 255, 255, 0.5);
        }

        .editable-group-name:focus {
            outline: 2px solid #0071e3;
            background: #ffffff;
            cursor: text;
            color: #1d1d1f;
        }

        .editable-group-name::after {
            content: "";
            opacity: 0;
            margin-left: 0;
            font-size: 0.7em;
            transition: opacity 0.2s ease;
        }

        .editable-group-name:hover::after {
            opacity: 0;
        }

        /* Styles pour l'édition inline des sous-titres de sections */
        .editable-section-title {
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 4px;
            padding: 4px 8px;
            margin: -4px -8px;
            display: inline-block;
            position: relative;
        }

        .editable-section-title:hover {
            background: rgba(0, 113, 227, 0.1);
            outline: 1px dashed rgba(0, 113, 227, 0.3);
        }

        .editable-section-title:focus {
            outline: 2px solid #0071e3;
            background: #ffffff;
            cursor: text;
        }

        .editable-section-title::after {
            content: "";
            opacity: 0;
            margin-left: 0;
            font-size: 0.7em;
            transition: opacity 0.2s ease;
        }

        .editable-section-title:hover::after {
            opacity: 0;
        }

        /* Bouton d'export en haut à droite */
        .export-button {
            position: absolute;
            top: 40px;
            right: 40px;
            background: #0071e3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s ease;
            z-index: 1000;
        }

        .export-button:hover {
            background: #0077ed;
        }

        .export-button:active {
            background: #005bb5;
        }

        /* Bouton toggle sticky - Style Apple discret */
        .sticky-toggle-container {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 8px;
            margin-bottom: 12px;
            padding: 8px 16px;
        }

        .sticky-toggle-label {
            font-size: 13px;
            color: #666666;
            font-weight: 500;
            user-select: none;
        }

        .sticky-toggle-btn {
            background: #e5e5e7;
            border: none;
            border-radius: 20px;
            padding: 4px;
            width: 48px;
            height: 28px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            display: flex;
            align-items: center;
        }

        .sticky-toggle-btn::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            left: 4px;
        }

        .sticky-toggle-btn:hover {
            background: #d1d1d6;
        }

        .sticky-toggle-btn.active {
            background: #0071e3;
        }

        .sticky-toggle-btn.active::before {
            transform: translateX(20px);
        }

        .sticky-charts-section.sticky-disabled {
            position: relative !important;
            top: 0 !important;
        }

        /* Séparateur pour ajouter un groupe */
        .group-separator {
            position: relative;
            margin: 24px 0;
            height: 1px;
            background: #e5e5e7;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .group-separator:hover {
            background: #d2d2d7;
        }

        .group-separator-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 8px 20px;
            color: #666666;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            transition: all 0.2s ease;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .group-separator:hover .group-separator-label {
            color: #0071e3;
            background: #f5f5f7;
        }

        .group-separator-icon {
            font-size: 16px;
            font-weight: 600;
        }

        /* Séparateur pour ajouter un risque (plus discret) */
        /* Ligne de séparateur invisible (pas d'espace ajouté) */
        .risk-separator-row {
            height: 0 !important;
            line-height: 0 !important;
            border: none !important;
        }

        .risk-separator-row td {
            padding: 0 !important;
            height: 0 !important;
            border: none !important;
            overflow: visible !important;
            position: relative;
        }

        .risk-separator {
            position: absolute;
            top: -10px;
            left: 0;
            right: 0;
            height: 20px;
            background: transparent;
            cursor: pointer;
            z-index: 10;
        }

        .risk-separator::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e5e5e7;
            opacity: 0;
            transition: opacity 0.2s ease;
            transform: translateY(-50%);
        }

        .risk-separator:hover::before {
            opacity: 1;
        }

        .risk-separator-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 4px 12px;
            color: #666666;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            transition: all 0.2s ease;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            z-index: 1;
            pointer-events: none;
        }

        .risk-separator:hover .risk-separator-label {
            opacity: 1;
            color: #0071e3;
        }

        .risk-separator-icon {
            font-size: 12px;
            font-weight: 600;
        }

        /* Effet visuel quand on drag sur un séparateur */
        .risk-separator-row.separator-drag-over .risk-separator::before {
            opacity: 1;
            height: 3px;
            background: #0071e3;
        }

        .risk-separator-row.separator-drag-over .risk-separator-label {
            opacity: 1;
            background: #0071e3;
            color: white;
            transform: translate(-50%, -50%) scale(1.1);
        }

        /* Toast Notifications pour feedback sauvegarde */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: #1d1d1f;
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
            opacity: 0;
            transform: translateY(20px);
            animation: toast-slide-in 0.3s ease forwards, toast-fade-out 0.3s ease 2.7s forwards;
            pointer-events: auto;
        }

        .toast.success {
            background: #0071e3;
        }

        .toast.error {
            background: #ff3b30;
        }

        @keyframes toast-slide-in {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes toast-fade-out {
            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        /* Highlight temporaire pour nouveaux risques */
        @keyframes highlight-new-row {
            0% {
                background-color: rgba(0, 113, 227, 0.2);
            }
            100% {
                background-color: transparent;
            }
        }

        .risks-table tbody tr.newly-added {
            animation: highlight-new-row 2s ease;
        }

        /* Boutons de suppression */
        .delete-btn {
            background: transparent;
            border: 1px solid #d2d2d7;
            color: #666666;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }

        .delete-btn:hover {
            background: #ff3b30;
            border-color: #ff3b30;
            color: white;
        }

        .delete-btn:active {
            transform: scale(0.95);
        }

        /* Bouton de suppression dans le header de groupe */
        .risk-group-header-collapsible .delete-btn {
            margin-left: auto;
        }

        /* Bouton de suppression dans les lignes de risques */
        .risks-table .delete-risk-btn {
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .risks-table tbody tr:hover .delete-risk-btn {
            opacity: 1;
        }

        /* Footer */
        .app-footer {
            margin-top: 60px;
            padding: 24px 0;
            text-align: center;
            color: #86868b;
            font-size: 13px;
            border-top: 1px solid #e5e5e7;
        }

        .app-footer a {
            color: #0071e3;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .app-footer a:hover {
            color: #0077ed;
            text-decoration: underline;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .footer-separator {
            color: #d2d2d7;
        }

        .footer-copyright {
            margin-top: 8px;
            font-size: 12px;
        }

        /* Badges de criticité */
        .criticality-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }

        .criticality-low {
            background: #C5E0B3;
            color: #2D5016;
        }

        .criticality-medium {
            background: #FFE699;
            color: #8B6914;
        }

        .criticality-high {
            background: #FFC7CE;
            color: #C00000;
        }

        .criticality-unevaluated {
            background: #F0F0F0;
            color: #666666;
            font-style: italic;
        }

        .criticality-score {
            font-weight: 700;
            font-size: 13px;
        }

        .criticality-cell {
            text-align: center !important;
            vertical-align: middle !important;
            padding: 6px 2px !important;
        }

        /* Badges de réduction du risque */
        .reduction-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }

        .reduction-positive {
            background: #D4F4DD;
            color: #1A6A3E;
        }

        .reduction-negative {
            background: #FFD4D4;
            color: #A02828;
        }

        .reduction-neutral {
            background: #F0F0F0;
            color: #666666;
        }

        .reduction-na {
            background: #F9F9FB;
            color: #999999;
            font-style: italic;
        }

        .reduction-cell {
            text-align: center !important;
            vertical-align: middle !important;
            padding: 6px 2px !important;
        }

        /* Dashboard de vue d'ensemble */
        .dashboard-overview {
            margin: 24px 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #ffffff 100%);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .dashboard-card {
            background: white;
            border-radius: 10px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .dashboard-card-icon {
            font-size: 32px;
            line-height: 1;
        }

        .dashboard-card-content {
            flex: 1;
        }

        .dashboard-card-value {
            font-size: 24px;
            font-weight: 700;
            color: #1d1d1f;
            margin-bottom: 4px;
        }

        .dashboard-card-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .app-header {
                flex-wrap: wrap;
                gap: 12px;
            }

            .app-controls {
                width: 100%;
                justify-content: flex-end;
            }

            h1 {
                font-size: 24px;
            }
        }

        @media (max-width: 480px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .app-header {
                gap: 10px;
            }

            .app-icon {
                width: 48px;
                height: 48px;
            }

            h1 {
                font-size: 20px;
            }

            #main-subtitle {
                font-size: 13px !important;
            }

            .app-controls {
                gap: 8px;
            }

            .app-controls select {
                font-size: 13px !important;
                padding: 6px 10px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header avec icône, titre et contrôles -->
        <div class="app-header">
            <img src="riskr.png" alt="Riskr" class="app-icon">

            <div class="app-title-section">
                <h1 id="main-title" class="editable-title"><span data-i18n="pageTitle">Riskr - Analyse de Risques Interactive</span></h1>
                <p id="main-subtitle" class="editable-subtitle" style="color: #86868b; margin: 4px 0 0 0; font-size: 15px;">Évaluation des risques avant et après remédiation</p>
            </div>

            <div class="app-controls">
                <select id="export-format-selector" onchange="handleExport(this.value)" style="padding: 8px 12px 8px 36px; font-size: 14px; border-radius: 8px; border: 1px solid #d2d2d7; background: white url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2216%22 height=%2216%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%2386868b%22 stroke-width=%222%22><path d=%22M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4%22/><polyline points=%227 10 12 15 17 10%22/><line x1=%2212%22 y1=%2215%22 x2=%2212%22 y2=%223%22/></svg>') no-repeat 10px center; cursor: pointer; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); appearance: none; padding-right: 30px; background-size: 16px;">
                    <option value="" disabled selected>Exporter...</option>
                    <option value="pdf">📄 PDF</option>
                    <option value="excel">📊 Excel (XLSX)</option>
                    <option value="csv">📋 CSV</option>
                    <option value="json">{ } JSON</option>
                </select>
                <select id="language-selector" onchange="setLanguage(this.value)" style="padding: 8px 12px; font-size: 14px; border-radius: 8px; border: 1px solid #d2d2d7; background: white; cursor: pointer; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                    <option value="fr">🇫🇷 Français</option>
                    <option value="en">🇬🇧 English</option>
                    <option value="es">🇪🇸 Español</option>
                    <option value="ar">🇸🇦 العربية</option>
                    <option value="zh">🇨🇳 中文</option>
                </select>
            </div>
        </div>

        <!-- Dashboard de vue d'ensemble -->
        <div class="dashboard-overview">
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="dashboard-card-icon">📋</div>
                    <div class="dashboard-card-content">
                        <div class="dashboard-card-value" id="dashboard-total-risks">-</div>
                        <div class="dashboard-card-label" data-i18n="dashboardRisksEvaluated">Risques évalués</div>
                    </div>
                </div>

                <div class="dashboard-card">
                    <div class="dashboard-card-icon">🟥</div>
                    <div class="dashboard-card-content">
                        <div class="dashboard-card-value">
                            <span id="dashboard-critical-before">-</span> → <span id="dashboard-critical-after">-</span>
                        </div>
                        <div class="dashboard-card-label" data-i18n="dashboardCriticalRisks">Risques critiques (Avant → Après)</div>
                    </div>
                </div>

                <div class="dashboard-card">
                    <div class="dashboard-card-icon">📉</div>
                    <div class="dashboard-card-content">
                        <div class="dashboard-card-value" id="dashboard-avg-reduction">-</div>
                        <div class="dashboard-card-label" data-i18n="dashboardAvgReduction">Réduction moyenne</div>
                    </div>
                </div>

                <div class="dashboard-card">
                    <div class="dashboard-card-icon">✅</div>
                    <div class="dashboard-card-content">
                        <div class="dashboard-card-value" id="dashboard-treated">-</div>
                        <div class="dashboard-card-label" data-i18n="dashboardTreated">Risques traités</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toggle sticky discret au-dessus -->
        <div class="sticky-toggle-container">
            <span class="sticky-toggle-label">Épingler la vue d'ensemble</span>
            <button onclick="toggleSticky()" class="sticky-toggle-btn" id="sticky-toggle-btn" title="Activer/Désactiver le mode collant"></button>
        </div>

        <!-- Matrices sticky en haut -->
        <div class="sticky-charts-section" id="sticky-section">

            <!-- Section collapsable pour les matrices -->
            <div class="collapsible-section" style="margin-bottom: 8px;">
                <h3 class="collapsible-header" onclick="toggleCollapse('matrices-content')" style="margin-top: 0; margin-bottom: 8px;">
                    <span class="collapse-icon">▼</span>
                    <span data-i18n="matricesTitle">Matrices des Risques</span>
                </h3>
                <div id="matrices-content" class="collapsible-content">
                    <div class="dashboard-layout">
                        <!-- Colonne gauche : Matrices -->
                        <div class="charts-column">
                            <div class="chart-wrapper">
                                <button class="zoom-btn" onclick="openMatrixModal('before')">🔍</button>
                                <div class="chart-header">
                                    <h3 data-i18n="matrixBefore">Matrice des risques non remédiés</h3>
                                </div>
                                <div class="chart-canvas">
                                    <canvas id="chartBefore"></canvas>
                                </div>
                            </div>

                            <div class="chart-wrapper">
                                <button class="zoom-btn" onclick="openMatrixModal('after')">🔍</button>
                                <div class="chart-header">
                                    <h3 data-i18n="matrixAfter">Matrice des risques remédiés</h3>
                                </div>
                                <div class="chart-canvas">
                                    <canvas id="chartAfter"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal d'agrandissement de matrice -->
            <div id="matrix-modal" class="matrix-modal" onclick="closeMatrixModal(event)">
                <div class="matrix-modal-content">
                    <button class="matrix-modal-close" onclick="closeMatrixModal(event)">✕</button>
                    <button class="matrix-nav-btn prev" onclick="event.stopPropagation(); navigateMatrix('prev')">‹</button>
                    <button class="matrix-nav-btn next" onclick="event.stopPropagation(); navigateMatrix('next')">›</button>
                    <h2 id="matrix-modal-title">Matrice des risques</h2>
                    <div class="matrix-modal-canvas">
                        <canvas id="chartModal"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tableau des groupes (inséré dynamiquement) -->
            <div id="group-table-wrapper">
                <!-- Le tableau sera inséré ici par JavaScript -->
            </div>

            <!-- Tableau récapitulatif des risques -->
            <div class="risk-table-container collapsible-section" style="margin-bottom: 0;">
                <h3 class="collapsible-header" onclick="toggleCollapse('risk-recap-table')" style="margin-bottom: 8px;">
                    <span class="collapse-icon">▼</span>
                    📋 <span data-i18n="riskTableTitle">Tableau Récapitulatif des Risques</span>
                </h3>
                <div id="risk-recap-table" class="collapsible-content">
                    <table class="risk-table">
                        <thead>
                            <tr>
                                <th data-i18n="colNumber">N°</th>
                                <th data-i18n="colDescription">Description du Risque</th>
                                <th data-i18n="colAvgBefore">Moyenne Avant</th>
                                <th data-i18n="colAvgAfter">Moyenne Après</th>
                            </tr>
                        </thead>
                        <tbody id="risk-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="risks-container"></div>
    </div>

    <!-- Footer -->
    <footer class="app-footer">
        <div class="footer-links">
            <a href="https://github.com/guthubrx/Riskr" target="_blank" rel="noopener noreferrer">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="vertical-align: text-bottom; margin-right: 4px;">
                    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                </svg>
                GitHub
            </a>
            <span class="footer-separator">•</span>
            <span>Licence AGPL-3.0</span>
        </div>
        <div class="footer-copyright">
            © 2025 Riskr — Application d'analyse et de cartographie des risques
        </div>
    </footer>

    <script>
        // ========================================
        // Système de Toast Notifications
        // ========================================

        // Créer le conteneur de toasts au chargement
        document.addEventListener('DOMContentLoaded', function() {
            if (!document.querySelector('.toast-container')) {
                const container = document.createElement('div');
                container.className = 'toast-container';
                document.body.appendChild(container);
            }
        });

        // Fonction pour afficher une notification toast
        function showToast(message, type = 'success') {
            const container = document.querySelector('.toast-container') ||
                              (() => {
                                  const c = document.createElement('div');
                                  c.className = 'toast-container';
                                  document.body.appendChild(c);
                                  return c;
                              })();

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;

            container.appendChild(toast);

            // Supprimer le toast après l'animation (3 secondes)
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // ========================================
        // Système Undo/Redo
        // ========================================
        let history = [];
        let historyIndex = -1;
        const MAX_HISTORY = 50;

        // Sauvegarder l'état actuel dans l'historique
        function saveState() {
            // Supprimer tous les états après l'index courant (si on a fait undo)
            history = history.slice(0, historyIndex + 1);

            // Créer une copie profonde de l'état actuel
            const state = {
                riskGroups: JSON.parse(JSON.stringify(riskGroups)),
                risks: JSON.parse(JSON.stringify(risks))
            };

            // Ajouter à l'historique
            history.push(state);

            // Limiter la taille de l'historique
            if (history.length > MAX_HISTORY) {
                history.shift();
            } else {
                historyIndex++;
            }
        }

        // Restaurer un état depuis l'historique
        function restoreState(state) {
            // Restaurer l'état
            riskGroups.length = 0;
            riskGroups.push(...JSON.parse(JSON.stringify(state.riskGroups)));

            risks.length = 0;
            risks.push(...JSON.parse(JSON.stringify(state.risks)));

            // Re-rendre l'interface
            renderRisks();
            updateCharts();
        }

        // Fonction Undo
        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                restoreState(history[historyIndex]);
                showToast('↶ Annulation');
            } else {
                showToast('Rien à annuler', 'error');
            }
        }

        // Fonction Redo
        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                restoreState(history[historyIndex]);
                showToast('↷ Rétablissement');
            } else {
                showToast('Rien à rétablir', 'error');
            }
        }

        // Écouter les raccourcis clavier
        document.addEventListener('keydown', function(e) {
            // Cmd+Z (Mac) ou Ctrl+Z (Windows/Linux) pour Undo
            if ((e.metaKey || e.ctrlKey) && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                undo();
            }
            // Cmd+Y (Mac) ou Ctrl+Y (Windows/Linux) pour Redo
            // Ou Cmd+Shift+Z (Mac) ou Ctrl+Shift+Z (Windows/Linux)
            else if ((e.metaKey || e.ctrlKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
                e.preventDefault();
                redo();
            }
        });

        // ========================================
        // Système d'édition inline pour titre et sous-titre
        // ========================================

        // Fonction pour initialiser l'édition inline (permet de modifier en cliquant)
        function initInlineEditing() {
            const title = document.getElementById('main-title');
            const subtitle = document.getElementById('main-subtitle');

            // Fonction pour rendre un élément éditable
            function makeEditable(element, storageKey) {
                // Éviter de réattacher les event listeners si déjà initialisé
                if (element.dataset.editingInitialized) return;
                element.dataset.editingInitialized = 'true';

                // Charger la valeur sauvegardée depuis le navigateur (localStorage)
                const savedValue = localStorage.getItem(storageKey);
                if (savedValue) {
                    element.textContent = savedValue;
                }

                // Activer l'édition au clic
                element.addEventListener('click', function() {
                    // Stocker la valeur originale pour comparaison
                    element.dataset.originalValue = element.textContent.trim();

                    element.contentEditable = true;
                    element.focus({preventScroll: true});

                    // Sélectionner tout le texte pour faciliter l'édition
                    const range = document.createRange();
                    range.selectNodeContents(element);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                });

                // Sauvegarder quand on perd le focus (clic ailleurs)
                element.addEventListener('blur', function() {
                    element.contentEditable = false;
                    const newValue = element.textContent.trim();
                    const originalValue = element.dataset.originalValue || '';

                    if (newValue) {
                        localStorage.setItem(storageKey, newValue);
                        console.log(`✅ Sauvegardé: ${storageKey} = "${newValue}"`);

                        // N'afficher le toast que si la valeur a changé
                        if (newValue !== originalValue) {
                            showToast('✅ Modification sauvegardée');
                        }
                    }
                });

                // Sauvegarder aussi quand on appuie sur Enter
                element.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault(); // Empêcher le retour à la ligne
                        element.blur(); // Déclencher la sauvegarde
                    }
                    // Echap pour annuler l'édition
                    if (e.key === 'Escape') {
                        element.textContent = localStorage.getItem(storageKey) || element.textContent;
                        element.blur();
                    }
                });
            }

            // Initialiser l'édition pour le titre et le sous-titre
            makeEditable(title, 'analysis-main-title');
            makeEditable(subtitle, 'analysis-main-subtitle');

            console.log('✏️ Édition inline activée pour le titre et le sous-titre');
        }

        // Lancer l'initialisation quand le DOM est prêt
        document.addEventListener('DOMContentLoaded', initInlineEditing);

        // ========================================
        // Toggle sticky mode
        // ========================================

        function toggleSticky() {
            const stickySection = document.getElementById('sticky-section');
            const toggleBtn = document.getElementById('sticky-toggle-btn');

            // Toggle : si active, on désactive ; si inactif, on active
            const isCurrentlyActive = toggleBtn.classList.contains('active');

            if (isCurrentlyActive) {
                // Désactiver sticky
                toggleBtn.classList.remove('active');
                stickySection.classList.add('sticky-disabled');
                localStorage.setItem('sticky-enabled', 'false');
                console.log(`📌 Mode sticky: DÉSACTIVÉ`);
            } else {
                // Activer sticky
                toggleBtn.classList.add('active');
                stickySection.classList.remove('sticky-disabled');
                localStorage.setItem('sticky-enabled', 'true');
                console.log(`📌 Mode sticky: ACTIVÉ`);
            }
        }

        // Restaurer l'état du sticky au chargement (LOGIQUE INVERSÉE)
        document.addEventListener('DOMContentLoaded', function() {
            const stickyEnabled = localStorage.getItem('sticky-enabled');
            const stickySection = document.getElementById('sticky-section');
            const toggleBtn = document.getElementById('sticky-toggle-btn');

            // Par défaut, sticky désactivé si pas de préférence
            if (stickyEnabled === 'true') {
                // Sticky activé = bouton vert (active) et section sticky
                toggleBtn.classList.add('active');
                stickySection.classList.remove('sticky-disabled');
            } else {
                // Sticky désactivé par défaut = bouton gris et section non-sticky
                toggleBtn.classList.remove('active');
                stickySection.classList.add('sticky-disabled');
            }
        });

        // ========================================
        // Système de collapse (plier/déplier) pour les sections
        // ========================================

        function toggleCollapse(contentId) {
            const content = document.getElementById(contentId);
            const header = content.previousElementSibling;

            // Toggle des classes (ajouter ou retirer la classe 'collapsed')
            header.classList.toggle('collapsed');
            content.classList.toggle('collapsed');

            // Sauvegarder l'état dans localStorage pour mémoriser la préférence
            const isCollapsed = content.classList.contains('collapsed');
            localStorage.setItem(`collapse-${contentId}`, isCollapsed);
        }

        // Restaurer l'état des sections au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            // Restaurer l'état du tableau récapitulatif
            const riskRecapTable = document.getElementById('risk-recap-table');
            const isCollapsedRecap = localStorage.getItem('collapse-risk-recap-table') === 'true';

            if (isCollapsedRecap && riskRecapTable) {
                const header = riskRecapTable.previousElementSibling;
                header.classList.add('collapsed');
                riskRecapTable.classList.add('collapsed');
            }

            // Restaurer l'état des matrices
            const matricesContent = document.getElementById('matrices-content');
            const isCollapsedMatrices = localStorage.getItem('collapse-matrices-content') === 'true';

            if (isCollapsedMatrices && matricesContent) {
                const header = matricesContent.previousElementSibling;
                header.classList.add('collapsed');
                matricesContent.classList.add('collapsed');
            }

            // Restaurer l'état de la section sticky complète
            const stickySectionContent = document.getElementById('sticky-section-content');
            const isCollapsedSticky = localStorage.getItem('collapse-sticky-section-content') === 'true';

            if (isCollapsedSticky && stickySectionContent) {
                const header = stickySectionContent.previousElementSibling;
                header.classList.add('collapsed');
                stickySectionContent.classList.add('collapsed');
            }
        });

        // ========================================
        // Édition inline des éléments de groupes et risques
        // ========================================

        function initGroupNameEditing() {
            // Cette fonction sera appelée après le rendu des groupes
            document.querySelectorAll('.editable-group-name').forEach(element => {
                // Éviter de réattacher les event listeners si déjà initialisé
                if (element.dataset.editingInitialized) return;
                element.dataset.editingInitialized = 'true';

                const groupId = element.getAttribute('data-group-id');
                const storageKey = `group-name-${groupId}`;

                // Charger la valeur sauvegardée
                const savedValue = localStorage.getItem(storageKey);
                if (savedValue) {
                    element.textContent = savedValue;
                    // Mettre à jour aussi dans l'objet riskGroups
                    const group = riskGroups.find(g => g.id == groupId);
                    if (group) {
                        group.name = savedValue;
                    }
                }

                // Activer l'édition au clic
                element.addEventListener('click', function(e) {
                    e.stopPropagation(); // Empêcher la propagation au header

                    // Stocker la valeur originale pour comparaison
                    element.dataset.originalValue = element.textContent.trim();

                    element.contentEditable = true;
                    element.focus({preventScroll: true});

                    // Sélectionner tout le texte
                    const range = document.createRange();
                    range.selectNodeContents(element);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                });

                // Sauvegarder quand on perd le focus
                element.addEventListener('blur', function() {
                    element.contentEditable = false;
                    const newValue = element.textContent.trim();
                    const originalValue = element.dataset.originalValue || '';

                    if (newValue) {
                        localStorage.setItem(storageKey, newValue);
                        // Mettre à jour dans l'objet riskGroups
                        const group = riskGroups.find(g => g.id == groupId);
                        if (group) {
                            group.name = newValue;
                        }
                        // Rafraîchir les graphiques et tableaux pour refléter le changement
                        updateCharts();
                        console.log(`✅ Nom du groupe ${groupId} sauvegardé: "${newValue}"`);

                        // N'afficher le toast que si la valeur a changé
                        if (newValue !== originalValue) {
                            showToast('✅ Modification sauvegardée');
                        }
                    }
                });

                // Sauvegarder avec Enter
                element.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        element.blur();
                    }
                    // Annuler avec Escape
                    if (e.key === 'Escape') {
                        element.textContent = localStorage.getItem(storageKey) || element.textContent;
                        element.blur();
                    }
                });
            });
        }

        function initGroupDescriptionEditing() {
            // Cette fonction sera appelée après le rendu des groupes
            document.querySelectorAll('.editable-group-description').forEach(element => {
                // Éviter de réattacher les event listeners si déjà initialisé
                if (element.dataset.editingInitialized) return;
                element.dataset.editingInitialized = 'true';

                const groupId = element.getAttribute('data-group-id');
                const storageKey = `group-desc-${groupId}`;

                // Charger la valeur sauvegardée
                const savedValue = localStorage.getItem(storageKey);
                if (savedValue) {
                    element.textContent = savedValue;
                    const group = riskGroups.find(g => g.id == groupId);
                    if (group) {
                        group.description = savedValue;
                    }
                }

                // Activer l'édition au clic
                element.addEventListener('click', function(e) {
                    e.stopPropagation();

                    // Stocker la valeur originale pour comparaison
                    element.dataset.originalValue = element.textContent.trim();

                    element.contentEditable = true;
                    element.focus({preventScroll: true});

                    const range = document.createRange();
                    range.selectNodeContents(element);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                });

                // Sauvegarder quand on perd le focus
                element.addEventListener('blur', function() {
                    element.contentEditable = false;
                    const newValue = element.textContent.trim();
                    const originalValue = element.dataset.originalValue || '';

                    if (newValue) {
                        localStorage.setItem(storageKey, newValue);
                        const group = riskGroups.find(g => g.id == groupId);
                        if (group) {
                            group.description = newValue;
                        }
                        console.log(`✅ Description du groupe ${groupId} sauvegardée: "${newValue}"`);

                        // N'afficher le toast que si la valeur a changé
                        if (newValue !== originalValue) {
                            showToast('✅ Modification sauvegardée');
                        }
                    }
                });

                // Sauvegarder avec Enter
                element.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        element.blur();
                    }
                    if (e.key === 'Escape') {
                        element.textContent = localStorage.getItem(storageKey) || element.textContent;
                        element.blur();
                    }
                });
            });
        }

        function initRiskTitleEditing() {
            // Cette fonction sera appelée après le rendu des risques
            document.querySelectorAll('.editable-risk-title').forEach(element => {
                // Éviter de réattacher les event listeners si déjà initialisé
                if (element.dataset.editingInitialized) return;
                element.dataset.editingInitialized = 'true';

                const riskId = element.getAttribute('data-risk-id');
                const storageKey = `risk-title-${riskId}`;

                // Charger la valeur sauvegardée
                const savedValue = localStorage.getItem(storageKey);
                if (savedValue) {
                    element.textContent = savedValue;
                    const risk = risks.find(r => r.id === riskId);
                    if (risk) {
                        risk.title = savedValue.replace(`${riskId}. `, '');
                    }
                }

                // Activer l'édition au clic
                element.addEventListener('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();

                    // Stocker la valeur originale pour comparaison
                    element.dataset.originalValue = element.textContent.trim();

                    // Désactiver le drag sur la ligne parente pendant l'édition
                    const row = element.closest('tr');
                    if (row) {
                        row.draggable = false;
                    }

                    element.contentEditable = true;
                    element.focus({preventScroll: true});

                    const range = document.createRange();
                    range.selectNodeContents(element);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                });

                // Sauvegarder quand on perd le focus
                element.addEventListener('blur', function() {
                    element.contentEditable = false;

                    // Réactiver le drag sur la ligne parente
                    const row = element.closest('tr');
                    if (row) {
                        row.draggable = true;
                    }

                    const newValue = element.textContent.trim();
                    const originalValue = element.dataset.originalValue || '';

                    if (newValue) {
                        localStorage.setItem(storageKey, newValue);
                        const risk = risks.find(r => r.id === riskId);
                        if (risk) {
                            risk.title = newValue.replace(`${riskId}. `, '');
                        }
                        updateCharts();
                        console.log(`✅ Titre du risque ${riskId} sauvegardé: "${newValue}"`);

                        // N'afficher le toast que si la valeur a changé
                        if (newValue !== originalValue) {
                            showToast('✅ Modification sauvegardée');
                        }
                    }
                });

                // Sauvegarder avec Enter
                element.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        element.blur();
                    }
                    if (e.key === 'Escape') {
                        element.textContent = localStorage.getItem(storageKey) || element.textContent;
                        element.blur();
                    }
                });
            });
        }

        // ========================================
        // Édition inline des remédiations
        // ========================================

        function initRemediationEditing() {
            document.querySelectorAll('.editable-remediation').forEach(element => {
                // Éviter de réattacher les event listeners si déjà initialisé
                if (element.dataset.editingInitialized) return;
                element.dataset.editingInitialized = 'true';

                const riskId = element.getAttribute('data-risk-id');
                const storageKey = `risk-remediation-${riskId}`;

                // Charger la valeur sauvegardée
                const savedValue = localStorage.getItem(storageKey);
                if (savedValue) {
                    element.textContent = savedValue;
                    const risk = risks.find(r => r.id === riskId);
                    if (risk) {
                        // Convertir le texte en tableau de mesures (séparé par •)
                        risk.mesures = savedValue.split(' • ').map(m => m.trim()).filter(m => m);
                    }
                }

                // Activer l'édition au clic
                element.addEventListener('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();

                    // Stocker la valeur originale pour comparaison
                    element.dataset.originalValue = element.textContent.trim();

                    // Désactiver le drag sur la ligne parente pendant l'édition
                    const row = element.closest('tr');
                    if (row) {
                        row.draggable = false;
                    }

                    element.contentEditable = true;
                    element.focus({preventScroll: true});

                    const range = document.createRange();
                    range.selectNodeContents(element);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                });

                // Sauvegarder quand on perd le focus
                element.addEventListener('blur', function() {
                    element.contentEditable = false;

                    // Réactiver le drag sur la ligne parente
                    const row = element.closest('tr');
                    if (row) {
                        row.draggable = true;
                    }

                    const newValue = element.textContent.trim();
                    const originalValue = element.dataset.originalValue || '';

                    if (newValue && newValue !== t('clickToAddRemediation')) {
                        localStorage.setItem(storageKey, newValue);
                        const risk = risks.find(r => r.id === riskId);
                        if (risk) {
                            // Convertir le texte en tableau de mesures (séparé par •)
                            risk.mesures = newValue.split(' • ').map(m => m.trim()).filter(m => m);
                            console.log(`✅ Remédiations du risque ${riskId} mises à jour:`, risk.mesures);
                        }

                        // N'afficher le toast que si la valeur a changé
                        if (newValue !== originalValue) {
                            showToast('✅ Modification sauvegardée');
                        }
                    }
                });

                // Sauvegarder avec Enter
                element.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        element.blur();
                    }
                    if (e.key === 'Escape') {
                        element.textContent = localStorage.getItem(storageKey) || element.textContent;
                        element.blur();
                    }
                });
            });
        }

        // ========================================
        // Gestion des dropdowns de statut
        // ========================================

        function initStatusDropdowns() {
            document.querySelectorAll('.status-dropdown').forEach(dropdown => {
                // Éviter de réattacher les event listeners si déjà initialisé
                if (dropdown.dataset.listenerInitialized) return;
                dropdown.dataset.listenerInitialized = 'true';

                const riskId = dropdown.getAttribute('data-risk-id');

                // Charger la valeur sauvegardée depuis localStorage
                const storageKey = `risk-status-${riskId}`;
                const savedStatus = localStorage.getItem(storageKey);
                if (savedStatus) {
                    dropdown.value = savedStatus;
                    const risk = risks.find(r => r.id === riskId);
                    if (risk) {
                        risk.statut = savedStatus;
                    }
                }

                // Écouter les changements de statut
                dropdown.addEventListener('change', function(e) {
                    const newStatus = e.target.value;

                    // Sauvegarder dans localStorage
                    localStorage.setItem(storageKey, newStatus);

                    // Mettre à jour l'objet risque
                    const risk = risks.find(r => r.id === riskId);
                    if (risk) {
                        risk.statut = newStatus;
                        console.log(`✅ Statut du risque ${riskId} mis à jour: ${newStatus}`);
                    }

                    showToast('✅ Statut mis à jour');
                });
            });
        }

        // ========================================
        // Édition inline du champ Responsable
        // ========================================

        function initResponsableEditing() {
            document.querySelectorAll('.editable-responsable').forEach(element => {
                // Éviter de réattacher les event listeners si déjà initialisé
                if (element.dataset.editingInitialized) return;
                element.dataset.editingInitialized = 'true';

                const riskId = element.getAttribute('data-risk-id');
                const storageKey = `risk-responsable-${riskId}`;

                // Charger la valeur sauvegardée
                const savedValue = localStorage.getItem(storageKey);
                if (savedValue) {
                    element.textContent = savedValue;
                    const risk = risks.find(r => r.id === riskId);
                    if (risk) {
                        risk.responsable = savedValue;
                    }
                }

                // Activer l'édition au clic
                element.addEventListener('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();

                    // Stocker la valeur originale pour comparaison
                    element.dataset.originalValue = element.textContent.trim();

                    // Désactiver le drag sur la ligne parente pendant l'édition
                    const row = element.closest('tr');
                    if (row) {
                        row.draggable = false;
                    }

                    element.contentEditable = true;
                    element.focus({preventScroll: true});

                    const range = document.createRange();
                    range.selectNodeContents(element);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                });

                // Sauvegarder quand on perd le focus
                element.addEventListener('blur', function() {
                    element.contentEditable = false;

                    // Réactiver le drag sur la ligne parente
                    const row = element.closest('tr');
                    if (row) {
                        row.draggable = true;
                    }

                    const newValue = element.textContent.trim();
                    const originalValue = element.dataset.originalValue || '';

                    // Si vide, afficher le placeholder
                    if (!newValue || newValue === t('clickToAdd')) {
                        element.textContent = t('clickToAdd');
                        localStorage.removeItem(storageKey);
                        const risk = risks.find(r => r.id === riskId);
                        if (risk) {
                            risk.responsable = '';
                        }
                    } else {
                        localStorage.setItem(storageKey, newValue);
                        const risk = risks.find(r => r.id === riskId);
                        if (risk) {
                            risk.responsable = newValue;
                            console.log(`✅ Responsable du risque ${riskId} mis à jour: ${newValue}`);
                        }

                        // N'afficher le toast que si la valeur a changé
                        if (newValue !== originalValue) {
                            showToast('✅ Modification sauvegardée');
                        }
                    }
                });

                // Sauvegarder avec Enter
                element.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        element.blur();
                    }
                    if (e.key === 'Escape') {
                        element.textContent = localStorage.getItem(storageKey) || t('clickToAdd');
                        element.blur();
                    }
                });
            });
        }

        // ========================================
        // Édition inline des sous-titres de sections
        // ========================================

        function initSectionTitleEditing() {
            // Cette fonction sera appelée après le rendu des risques
            document.querySelectorAll('.editable-section-title').forEach(element => {
                // Éviter de réattacher les event listeners si déjà initialisé
                if (element.dataset.editingInitialized) return;
                element.dataset.editingInitialized = 'true';

                const riskIndex = element.getAttribute('data-risk-index');
                const sectionType = element.getAttribute('data-section-type');
                const storageKey = `section-title-${riskIndex}-${sectionType}`;

                // Charger la valeur sauvegardée
                const savedValue = localStorage.getItem(storageKey);
                if (savedValue) {
                    element.textContent = savedValue;
                }

                // Activer l'édition au clic
                element.addEventListener('click', function(e) {
                    e.stopPropagation();

                    // Stocker la valeur originale pour comparaison
                    element.dataset.originalValue = element.textContent.trim();

                    element.contentEditable = true;
                    element.focus({preventScroll: true});
                    // Sélectionner tout le texte
                    const range = document.createRange();
                    range.selectNodeContents(element);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                });

                // Sauvegarder quand on perd le focus
                element.addEventListener('blur', function() {
                    element.contentEditable = false;
                    const newValue = element.textContent.trim();
                    const originalValue = element.dataset.originalValue || '';

                    if (newValue) {
                        localStorage.setItem(storageKey, newValue);
                        console.log(`✅ Sous-titre de section sauvegardé: "${newValue}"`);

                        // N'afficher le toast que si la valeur a changé
                        if (newValue !== originalValue) {
                            showToast('✅ Modification sauvegardée');
                        }
                    }
                });

                // Sauvegarder avec Enter
                element.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        element.blur();
                    }
                    // Annuler avec Escape
                    if (e.key === 'Escape') {
                        element.textContent = localStorage.getItem(storageKey) || element.textContent;
                        element.blur();
                    }
                });
            });
        }

        // ========================================
        // Fonction d'export vers fichier HTML
        // ========================================

        function exportToHTML() {
            // Récupérer les valeurs modifiées depuis localStorage
            const savedTitle = localStorage.getItem('analysis-main-title');
            const savedSubtitle = localStorage.getItem('analysis-main-subtitle');

            // Récupérer le contenu HTML complet de la page
            let htmlContent = document.documentElement.outerHTML;

            // Remplacer le titre par la valeur sauvegardée (si elle existe)
            if (savedTitle) {
                const titleElement = document.getElementById('main-title');
                const originalTitle = 'Riskr - Analyse de Risques Interactive';
                // Remplacer l'ancien titre par le nouveau dans le HTML
                htmlContent = htmlContent.replace(
                    `<h1 id="main-title" class="editable-title">${originalTitle}</h1>`,
                    `<h1 id="main-title" class="editable-title">${savedTitle}</h1>`
                );
                // Remplacer aussi si le titre a déjà été modifié
                const currentTitle = titleElement.textContent;
                htmlContent = htmlContent.replace(
                    `<h1 id="main-title" class="editable-title">${currentTitle}</h1>`,
                    `<h1 id="main-title" class="editable-title">${savedTitle}</h1>`
                );
            }

            // Remplacer le sous-titre par la valeur sauvegardée (si elle existe)
            if (savedSubtitle) {
                const subtitleElement = document.getElementById('main-subtitle');
                const originalSubtitle = 'Évaluation des risques avant et après remédiation';
                // Remplacer l'ancien sous-titre par le nouveau dans le HTML
                htmlContent = htmlContent.replace(
                    `style="color: #666; margin-bottom: 20px;">${originalSubtitle}</p>`,
                    `style="color: #666; margin-bottom: 20px;">${savedSubtitle}</p>`
                );
                // Remplacer aussi si le sous-titre a déjà été modifié
                const currentSubtitle = subtitleElement.textContent;
                htmlContent = htmlContent.replace(
                    `style="color: #666; margin-bottom: 20px;">${currentSubtitle}</p>`,
                    `style="color: #666; margin-bottom: 20px;">${savedSubtitle}</p>`
                );
            }

            // Créer un Blob (objet fichier en mémoire) avec le contenu HTML
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });

            // Créer un lien de téléchargement temporaire
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);

            // Générer un nom de fichier avec date et heure
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10); // Format: YYYY-MM-DD
            const timeStr = now.toTimeString().slice(0, 5).replace(':', 'h'); // Format: HHhMM
            link.download = `analyse_risque_v2_export_${dateStr}_${timeStr}.html`;

            // Ajouter le lien au document, cliquer dessus, puis le retirer
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // Libérer la mémoire du Blob
            URL.revokeObjectURL(link.href);

            console.log('✅ Export HTML réussi ! Fichier téléchargé avec vos modifications.');
        }

        // ========================================
        // Fonction de dispatch pour les exports
        // ========================================

        function handleExport(format) {
            if (!format) return;

            switch(format) {
                case 'pdf':
                    exportToPDF();
                    break;
                case 'excel':
                    exportToExcel();
                    break;
                case 'csv':
                    exportToCSV();
                    break;
                case 'json':
                    exportToHTML(); // Export JSON (HTML avec données)
                    break;
            }

            // Réinitialiser le sélecteur
            document.getElementById('export-format-selector').value = '';
        }

        // ========================================
        // Export PDF avec jsPDF
        // ========================================

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const title = document.getElementById('main-title').textContent;
            const subtitle = document.getElementById('main-subtitle').textContent;

            // Titre du document
            doc.setFontSize(18);
            doc.text(title, 105, 20, { align: 'center' });
            doc.setFontSize(12);
            doc.text(subtitle, 105, 30, { align: 'center' });

            let yPosition = 40;

            // Ajouter les matrices (Before et After) sur la première page
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Matrices de risques', 105, yPosition, { align: 'center' });
            yPosition += 10;

            // Capturer les canvas des matrices et les ajouter au PDF
            const chartBefore = document.getElementById('chartBefore');
            const chartAfter = document.getElementById('chartAfter');

            if (chartBefore) {
                const imgBefore = chartBefore.toDataURL('image/png');
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Avant remédiation', 105, yPosition, { align: 'center' });
                yPosition += 5;
                doc.addImage(imgBefore, 'PNG', 15, yPosition, 85, 85);
                yPosition -= 5;
            }

            if (chartAfter) {
                const imgAfter = chartAfter.toDataURL('image/png');
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Après remédiation', 195, yPosition, { align: 'center' });
                yPosition += 5;
                doc.addImage(imgAfter, 'PNG', 110, yPosition, 85, 85);
                yPosition += 90;
            } else {
                yPosition += 10;
            }

            yPosition += 10;

            // Pour chaque groupe de risques
            riskGroups.forEach((group, groupIndex) => {
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }

                // Titre du groupe
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text(`${groupIndex + 1}. ${group.name}`, 15, yPosition);
                yPosition += 10;

                if (group.risks && group.risks.length > 0) {
                    // Préparer les données du tableau
                    const tableData = group.risks.map(risk => {
                        const probBefore = risk.gcBefore[0] || '-';
                        const impactBefore = risk.gcBefore[1] || '-';
                        const critBefore = calculateCriticality(risk.gcBefore[0], risk.gcBefore[1]) || '-';
                        const probAfter = risk.gcAfter[0] || '-';
                        const impactAfter = risk.gcAfter[1] || '-';
                        const critAfter = calculateCriticality(risk.gcAfter[0], risk.gcAfter[1]) || '-';
                        const reduction = critBefore !== '-' && critAfter !== '-'
                            ? `${((1 - critAfter/critBefore) * 100).toFixed(0)}%`
                            : '-';

                        return [
                            risk.id,
                            risk.title,
                            probBefore,
                            impactBefore,
                            critBefore,
                            probAfter,
                            impactAfter,
                            critAfter,
                            reduction
                        ];
                    });

                    // Créer le tableau avec autoTable
                    doc.autoTable({
                        startY: yPosition,
                        head: [['#', 'Risque', 'P.Av', 'I.Av', 'C.Av', 'P.Ap', 'I.Ap', 'C.Ap', 'Réd.']],
                        body: tableData,
                        theme: 'grid',
                        styles: { fontSize: 8, cellPadding: 2 },
                        headStyles: { fillColor: [0, 113, 227], textColor: 255 },
                        columnStyles: {
                            0: { cellWidth: 10 },
                            1: { cellWidth: 60 },
                            2: { cellWidth: 12 },
                            3: { cellWidth: 12 },
                            4: { cellWidth: 12 },
                            5: { cellWidth: 12 },
                            6: { cellWidth: 12 },
                            7: { cellWidth: 12 },
                            8: { cellWidth: 15 }
                        }
                    });

                    yPosition = doc.lastAutoTable.finalY + 10;
                } else {
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(10);
                    doc.text('Aucun risque', 20, yPosition);
                    yPosition += 10;
                }
            });

            // Télécharger le PDF
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10);
            doc.save(`riskr_export_${dateStr}.pdf`);

            console.log('✅ Export PDF réussi !');
        }

        // ========================================
        // Export Excel (XLSX) avec SheetJS
        // ========================================

        function exportToExcel() {
            const wb = XLSX.utils.book_new();

            // Créer une feuille par groupe
            riskGroups.forEach(group => {
                const sheetData = [];

                // En-têtes
                sheetData.push(['#', 'Risque', 'Remédiations', 'Prob.Avant', 'Impact Avant', 'Crit.Avant', 'Prob.Après', 'Impact Après', 'Crit.Après', 'Réduction', 'Statut', 'Responsable']);

                // Données des risques
                group.risks.forEach(risk => {
                    const probBefore = risk.gcBefore[0] || '';
                    const impactBefore = risk.gcBefore[1] || '';
                    const critBefore = calculateCriticality(risk.gcBefore[0], risk.gcBefore[1]) || '';
                    const probAfter = risk.gcAfter[0] || '';
                    const impactAfter = risk.gcAfter[1] || '';
                    const critAfter = calculateCriticality(risk.gcAfter[0], risk.gcAfter[1]) || '';
                    const reduction = critBefore && critAfter
                        ? ((1 - critAfter/critBefore) * 100).toFixed(0) + '%'
                        : '';
                    const remediations = risk.mesures && risk.mesures.length > 0
                        ? risk.mesures.join(' • ')
                        : '';

                    sheetData.push([
                        risk.id,
                        risk.title,
                        remediations,
                        probBefore,
                        impactBefore,
                        critBefore,
                        probAfter,
                        impactAfter,
                        critAfter,
                        reduction,
                        risk.statut || '',
                        risk.responsable || ''
                    ]);
                });

                // Créer la feuille
                const ws = XLSX.utils.aoa_to_sheet(sheetData);

                // Définir les largeurs de colonnes
                ws['!cols'] = [
                    { wch: 5 },  // #
                    { wch: 40 }, // Risque
                    { wch: 50 }, // Remédiations
                    { wch: 10 }, // Prob.Avant
                    { wch: 12 }, // Impact Avant
                    { wch: 10 }, // Crit.Avant
                    { wch: 10 }, // Prob.Après
                    { wch: 12 }, // Impact Après
                    { wch: 10 }, // Crit.Après
                    { wch: 10 }, // Réduction
                    { wch: 15 }, // Statut
                    { wch: 20 }  // Responsable
                ];

                // Nom de la feuille (max 31 caractères)
                let sheetName = group.name.substring(0, 31);
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
            });

            // Télécharger le fichier Excel
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10);
            XLSX.writeFile(wb, `riskr_export_${dateStr}.xlsx`);

            console.log('✅ Export Excel réussi !');
        }

        // ========================================
        // Export CSV
        // ========================================

        function exportToCSV() {
            let csvContent = '';

            // En-têtes CSV
            csvContent += '#,Groupe,Risque,Remédiations,Prob.Avant,Impact Avant,Crit.Avant,Prob.Après,Impact Après,Crit.Après,Réduction,Statut,Responsable\n';

            // Données
            riskGroups.forEach(group => {
                group.risks.forEach(risk => {
                    const probBefore = risk.gcBefore[0] || '';
                    const impactBefore = risk.gcBefore[1] || '';
                    const critBefore = calculateCriticality(risk.gcBefore[0], risk.gcBefore[1]) || '';
                    const probAfter = risk.gcAfter[0] || '';
                    const impactAfter = risk.gcAfter[1] || '';
                    const critAfter = calculateCriticality(risk.gcAfter[0], risk.gcAfter[1]) || '';
                    const reduction = critBefore && critAfter
                        ? ((1 - critAfter/critBefore) * 100).toFixed(0) + '%'
                        : '';
                    const remediations = risk.mesures && risk.mesures.length > 0
                        ? risk.mesures.join(' • ')
                        : '';

                    // Échapper les guillemets et entourer les champs avec des guillemets si nécessaire
                    const escapeCSV = (str) => {
                        str = String(str);
                        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                            return '"' + str.replace(/"/g, '""') + '"';
                        }
                        return str;
                    };

                    csvContent += [
                        risk.id,
                        escapeCSV(group.name),
                        escapeCSV(risk.title),
                        escapeCSV(remediations),
                        probBefore,
                        impactBefore,
                        critBefore,
                        probAfter,
                        impactAfter,
                        critAfter,
                        reduction,
                        escapeCSV(risk.statut || ''),
                        escapeCSV(risk.responsable || '')
                    ].join(',') + '\n';
                });
            });

            // Créer le Blob et télécharger
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10);
            link.download = `riskr_export_${dateStr}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);

            console.log('✅ Export CSV réussi !');
        }

        // ========================================
        // Système multilingue
        // ========================================

        const translations = {
            fr: {
                // Titre et sous-titre
                pageTitle: "Riskr - Analyse de Risques Interactive",
                pageSubtitle: "Évaluation des risques avant et après remédiation",

                // Boutons principaux
                exportBtn: "Exporter",
                exportTooltip: "Télécharger une copie avec vos modifications",
                undoBtn: "Annuler",
                undoTooltip: "Annuler la dernière action (Cmd/Ctrl+Z)",
                redoBtn: "Refaire",
                redoTooltip: "Refaire l'action annulée (Cmd/Ctrl+Y)",

                // Dashboard
                dashboardTitle: "Vue d'ensemble",
                dashboardRisksEvaluated: "Risques évalués",
                dashboardCriticalRisks: "Risques critiques (Avant → Après)",
                dashboardAvgReduction: "Réduction moyenne",
                dashboardTreated: "Risques traités",

                // Sections
                matricesTitle: "Matrices des Risques",
                matrixBefore: "Matrice des risques non remédiés",
                matrixAfter: "Matrice des risques remédiés",
                riskTableTitle: "Tableau Récapitulatif des Risques",

                // Tableau récap
                colNumber: "N°",
                colDescription: "Description du Risque",
                colAvgBefore: "Moyenne Avant",
                colAvgAfter: "Moyenne Après",

                // Colonnes tableau
                colRisk: "Risque",
                colRemediations: "Remédiations",
                colBefore: "AVANT",
                colAfter: "APRÈS",
                colProb: "Prob.",
                colImpact: "Impact",
                colCriticality: "Criticité",
                colReduction: "Réduction",
                colStatus: "Statut",
                colResp: "Resp.",

                // Labels axes matrices
                axisProb: "Probabilité →",
                axisImpact: "↑ Impact",

                // Probabilités
                probNotEval: "Non évalué",
                probVeryUnlikely: "Très improbable (< 5%)",
                probUnlikely: "Improbable (5-25%)",
                probPossible: "Possible (25-50%)",
                probLikely: "Probable (50-75%)",

                // Impacts
                impactNotEval: "Non évalué",
                impactMinor: "Mineur (< 1M€)",
                impactModerate: "Modéré (1-5M€)",
                impactSignificant: "Significatif (5-20M€)",
                impactMajor: "Majeur (> 20M€)",

                // Statuts
                statusNotTreated: "Non traité",
                statusInProgress: "En cours",
                statusTreated: "Traité",
                statusAccepted: "Accepté",

                // Badges de criticité
                critNotEval: "Non évalué",
                critLow: "Acceptable",
                critMedium: "À surveiller",
                critHigh: "Critique",

                // Actions
                addGroup: "Ajouter un groupe",
                addRisk: "Ajouter un risque",
                deleteGroup: "Supprimer",
                clickToAdd: "Cliquer pour ajouter",
                clickToAddRemediation: "Cliquer pour ajouter des remédiations",
                zoomMatrix: "Agrandir la matrice"
            },
            en: {
                pageTitle: "Riskr - Interactive Risk Analysis",
                pageSubtitle: "Risk assessment before and after remediation",

                exportBtn: "Export",
                exportTooltip: "Download a copy with your modifications",
                undoBtn: "Undo",
                undoTooltip: "Undo last action (Cmd/Ctrl+Z)",
                redoBtn: "Redo",
                redoTooltip: "Redo undone action (Cmd/Ctrl+Y)",

                dashboardTitle: "Overview",
                dashboardRisksEvaluated: "Evaluated risks",
                dashboardCriticalRisks: "Critical risks (Before → After)",
                dashboardAvgReduction: "Average reduction",
                dashboardTreated: "Treated risks",

                matricesTitle: "Risk Matrices",
                matrixBefore: "Unmitigated risks matrix",
                matrixAfter: "Mitigated risks matrix",
                riskTableTitle: "Risk Summary Table",

                colNumber: "No.",
                colDescription: "Risk Description",
                colAvgBefore: "Average Before",
                colAvgAfter: "Average After",

                colRisk: "Risk",
                colRemediations: "Remediations",
                colBefore: "BEFORE",
                colAfter: "AFTER",
                colProb: "Prob.",
                colImpact: "Impact",
                colCriticality: "Criticality",
                colReduction: "Reduction",
                colStatus: "Status",
                colResp: "Owner",

                axisProb: "Probability →",
                axisImpact: "↑ Impact",

                probNotEval: "Not evaluated",
                probVeryUnlikely: "Very unlikely (< 5%)",
                probUnlikely: "Unlikely (5-25%)",
                probPossible: "Possible (25-50%)",
                probLikely: "Likely (50-75%)",

                impactNotEval: "Not evaluated",
                impactMinor: "Minor (< $1M)",
                impactModerate: "Moderate ($1-5M)",
                impactSignificant: "Significant ($5-20M)",
                impactMajor: "Major (> $20M)",

                statusNotTreated: "Not treated",
                statusInProgress: "In progress",
                statusTreated: "Treated",
                statusAccepted: "Accepted",

                critNotEval: "Not evaluated",
                critLow: "Acceptable",
                critMedium: "Monitor",
                critHigh: "Critical",

                addGroup: "Add group",
                addRisk: "Add risk",
                deleteGroup: "Delete",
                clickToAdd: "Click to add",
                clickToAddRemediation: "Click to add remediations",
                zoomMatrix: "Enlarge matrix"
            },
            es: {
                pageTitle: "Riskr - Análisis de Riesgos Interactivo",
                pageSubtitle: "Evaluación de riesgos antes y después de la remediación",

                exportBtn: "Exportar",
                exportTooltip: "Descargar una copia con sus modificaciones",
                undoBtn: "Deshacer",
                undoTooltip: "Deshacer última acción (Cmd/Ctrl+Z)",
                redoBtn: "Rehacer",
                redoTooltip: "Rehacer acción deshecha (Cmd/Ctrl+Y)",

                dashboardTitle: "Vista general",
                dashboardRisksEvaluated: "Riesgos evaluados",
                dashboardCriticalRisks: "Riesgos críticos (Antes → Después)",
                dashboardAvgReduction: "Reducción promedio",
                dashboardTreated: "Riesgos tratados",

                matricesTitle: "Matrices de Riesgos",
                matrixBefore: "Matriz de riesgos no remediados",
                matrixAfter: "Matriz de riesgos remediados",
                riskTableTitle: "Tabla Resumen de Riesgos",

                colNumber: "N°",
                colDescription: "Descripción del Riesgo",
                colAvgBefore: "Promedio Antes",
                colAvgAfter: "Promedio Después",

                colRisk: "Riesgo",
                colRemediations: "Remediaciones",
                colBefore: "ANTES",
                colAfter: "DESPUÉS",
                colProb: "Prob.",
                colImpact: "Impacto",
                colCriticality: "Criticidad",
                colReduction: "Reducción",
                colStatus: "Estado",
                colResp: "Resp.",

                axisProb: "Probabilidad →",
                axisImpact: "↑ Impacto",

                probNotEval: "No evaluado",
                probVeryUnlikely: "Muy improbable (< 5%)",
                probUnlikely: "Improbable (5-25%)",
                probPossible: "Posible (25-50%)",
                probLikely: "Probable (50-75%)",

                impactNotEval: "No evaluado",
                impactMinor: "Menor (< 1M€)",
                impactModerate: "Moderado (1-5M€)",
                impactSignificant: "Significativo (5-20M€)",
                impactMajor: "Mayor (> 20M€)",

                statusNotTreated: "No tratado",
                statusInProgress: "En curso",
                statusTreated: "Tratado",
                statusAccepted: "Aceptado",

                critNotEval: "No evaluado",
                critLow: "Aceptable",
                critMedium: "Vigilar",
                critHigh: "Crítico",

                addGroup: "Agregar grupo",
                addRisk: "Agregar riesgo",
                deleteGroup: "Eliminar",
                clickToAdd: "Clic para agregar",
                clickToAddRemediation: "Clic para agregar remediaciones",
                zoomMatrix: "Ampliar matriz"
            },
            zh: {
                pageTitle: "Riskr - 交互式风险分析",
                pageSubtitle: "修复前后的风险评估",

                exportBtn: "导出",
                exportTooltip: "下载带有修改的副本",
                undoBtn: "撤销",
                undoTooltip: "撤销上一步操作 (Cmd/Ctrl+Z)",
                redoBtn: "重做",
                redoTooltip: "重做已撤销的操作 (Cmd/Ctrl+Y)",

                dashboardTitle: "概览",
                dashboardRisksEvaluated: "已评估风险",
                dashboardCriticalRisks: "关键风险 (前 → 后)",
                dashboardAvgReduction: "平均降低",
                dashboardTreated: "已处理风险",

                matricesTitle: "风险矩阵",
                matrixBefore: "未缓解风险矩阵",
                matrixAfter: "已缓解风险矩阵",
                riskTableTitle: "风险汇总表",

                colNumber: "编号",
                colDescription: "风险描述",
                colAvgBefore: "平均之前",
                colAvgAfter: "平均之后",

                colRisk: "风险",
                colRemediations: "缓解措施",
                colBefore: "之前",
                colAfter: "之后",
                colProb: "概率",
                colImpact: "影响",
                colCriticality: "严重性",
                colReduction: "降低",
                colStatus: "状态",
                colResp: "负责人",

                axisProb: "概率 →",
                axisImpact: "↑ 影响",

                probNotEval: "未评估",
                probVeryUnlikely: "非常不可能 (< 5%)",
                probUnlikely: "不太可能 (5-25%)",
                probPossible: "可能 (25-50%)",
                probLikely: "很可能 (50-75%)",

                impactNotEval: "未评估",
                impactMinor: "轻微 (< 1M€)",
                impactModerate: "中等 (1-5M€)",
                impactSignificant: "显著 (5-20M€)",
                impactMajor: "重大 (> 20M€)",

                statusNotTreated: "未处理",
                statusInProgress: "进行中",
                statusTreated: "已处理",
                statusAccepted: "已接受",

                critNotEval: "未评估",
                critLow: "可接受",
                critMedium: "需监控",
                critHigh: "关键",

                addGroup: "添加组",
                addRisk: "添加风险",
                deleteGroup: "删除",
                clickToAdd: "点击添加",
                clickToAddRemediation: "点击添加缓解措施",
                zoomMatrix: "放大矩阵"
            },
            ar: {
                pageTitle: "Riskr - تحليل المخاطر التفاعلي",
                pageSubtitle: "تقييم المخاطر قبل وبعد المعالجة",

                exportBtn: "تصدير",
                exportTooltip: "تنزيل نسخة مع تعديلاتك",
                undoBtn: "تراجع",
                undoTooltip: "التراجع عن الإجراء الأخير (Cmd/Ctrl+Z)",
                redoBtn: "إعادة",
                redoTooltip: "إعادة الإجراء الملغي (Cmd/Ctrl+Y)",

                dashboardTitle: "نظرة عامة",
                dashboardRisksEvaluated: "المخاطر المقيمة",
                dashboardCriticalRisks: "المخاطر الحرجة (قبل ← بعد)",
                dashboardAvgReduction: "متوسط الانخفاض",
                dashboardTreated: "المخاطر المعالجة",

                matricesTitle: "مصفوفات المخاطر",
                matrixBefore: "مصفوفة المخاطر غير المعالجة",
                matrixAfter: "مصفوفة المخاطر المعالجة",
                riskTableTitle: "جدول ملخص المخاطر",

                colNumber: "رقم",
                colDescription: "وصف المخاطرة",
                colAvgBefore: "متوسط قبل",
                colAvgAfter: "متوسط بعد",

                colRisk: "المخاطرة",
                colRemediations: "المعالجات",
                colBefore: "قبل",
                colAfter: "بعد",
                colProb: "احتمال",
                colImpact: "تأثير",
                colCriticality: "حرجة",
                colReduction: "انخفاض",
                colStatus: "حالة",
                colResp: "مسؤول",

                axisProb: "الاحتمال ←",
                axisImpact: "↑ التأثير",

                probNotEval: "غير مقيم",
                probVeryUnlikely: "مستبعد جداً (< 5%)",
                probUnlikely: "مستبعد (5-25%)",
                probPossible: "ممكن (25-50%)",
                probLikely: "محتمل (50-75%)",

                impactNotEval: "غير مقيم",
                impactMinor: "طفيف (< 1M€)",
                impactModerate: "متوسط (1-5M€)",
                impactSignificant: "كبير (5-20M€)",
                impactMajor: "رئيسي (> 20M€)",

                statusNotTreated: "غير معالج",
                statusInProgress: "قيد المعالجة",
                statusTreated: "معالج",
                statusAccepted: "مقبول",

                critNotEval: "غير مقيم",
                critLow: "مقبول",
                critMedium: "للمراقبة",
                critHigh: "حرج",

                addGroup: "إضافة مجموعة",
                addRisk: "إضافة مخاطرة",
                deleteGroup: "حذف",
                clickToAdd: "انقر للإضافة",
                clickToAddRemediation: "انقر لإضافة المعالجات",
                zoomMatrix: "تكبير المصفوفة"
            }
        };

        let currentLanguage = localStorage.getItem('riskr-language') || 'fr';

        function t(key) {
            return translations[currentLanguage][key] || translations.fr[key] || key;
        }

        // ========================================
        // Données des échelles
        // ========================================

        function getProbabilityScale() {
            return [
                {value: 0, label: t('probNotEval'), color: "#F0F0F0", emoji: "⚪"},
                {value: 1, label: t('probVeryUnlikely'), color: "#C5E0B3", emoji: "🟩"},
                {value: 2, label: t('probUnlikely'), color: "#FFE699", emoji: "🟨"},
                {value: 3, label: t('probPossible'), color: "#F4B183", emoji: "🟧"},
                {value: 4, label: t('probLikely'), color: "#FFC7CE", emoji: "🟥"}
            ];
        }

        function getImpactScale() {
            return [
                {value: 0, label: t('impactNotEval'), color: "#F0F0F0", emoji: "⚪"},
                {value: 1, label: t('impactMinor'), color: "#C5E0B3", emoji: "🟩"},
                {value: 2, label: t('impactModerate'), color: "#FFE699", emoji: "🟨"},
                {value: 3, label: t('impactSignificant'), color: "#F4B183", emoji: "🟧"},
                {value: 4, label: t('impactMajor'), color: "#FFC7CE", emoji: "🟥"}
            ];
        }

        function getStatusOptions() {
            return [
                { value: "statusNotTreated", label: t('statusNotTreated'), emoji: "⚪" },
                { value: "statusInProgress", label: t('statusInProgress'), emoji: "🔄" },
                { value: "statusTreated", label: t('statusTreated'), emoji: "✅" },
                { value: "statusAccepted", label: t('statusAccepted'), emoji: "🤝" }
            ];
        }

        // Helper pour générer les options avec carrés colorés
        function generateOptions(scale, selectedValue) {
            return scale.map(item =>
                `<option value="${item.value}" ${item.value === selectedValue ? 'selected' : ''} style="background-color: ${item.color};">${item.emoji} ${item.label}</option>`
            ).join('');
        }

        // Helper pour générer les options de statut
        function generateStatusOptions(selectedStatus) {
            const statusOptions = getStatusOptions();

            return statusOptions.map(item =>
                `<option value="${item.value}" ${item.value === selectedStatus ? 'selected' : ''}>${item.emoji} ${item.label}</option>`
            ).join('');
        }

        // ========================================
        // Fonctions de calcul de criticité
        // ========================================

        // Calcule le score de criticité (Probabilité × Impact)
        // Retourne null si l'un des deux n'est pas évalué (valeur 0)
        function calculateCriticality(probability, impact) {
            if (probability === 0 || impact === 0) {
                return null;
            }
            return probability * impact;
        }

        // Détermine le niveau de risque selon le score
        function getCriticalityLevel(score) {
            if (score === null) return null;
            if (score >= 10) return 'high';      // Rouge: 10-16 (critique)
            if (score >= 5) return 'medium';     // Orange: 5-9 (à surveiller)
            return 'low';                        // Vert: 1-4 (acceptable)
        }

        // Génère le badge HTML de criticité
        function getCriticalityBadge(probability, impact) {
            const score = calculateCriticality(probability, impact);

            // Si non évalué, afficher un badge gris
            if (score === null) {
                return `<span class="criticality-badge criticality-unevaluated">
                    ⚪ ${t('critNotEval')}
                </span>`;
            }

            const level = getCriticalityLevel(score);

            const labelKeys = {
                low: 'critLow',
                medium: 'critMedium',
                high: 'critHigh'
            };

            const emojis = {
                low: '🟩',
                medium: '🟧',
                high: '🟥'
            };

            return `<span class="criticality-badge criticality-${level}">
                ${emojis[level]} <span class="criticality-score">${score}</span> ${t(labelKeys[level])}
            </span>`;
        }

        // ========================================
        // Calcul du % de réduction du risque
        // ========================================

        // Calcule le pourcentage de réduction du risque
        // Formule : (criticité_avant - criticité_après) / criticité_avant × 100
        function calculateRiskReduction(probBefore, impactBefore, probAfter, impactAfter) {
            const criticalityBefore = calculateCriticality(probBefore, impactBefore);
            const criticalityAfter = calculateCriticality(probAfter, impactAfter);

            // Si l'une des deux criticités n'est pas évaluée, retourner null
            if (criticalityBefore === null || criticalityAfter === null) {
                return null;
            }

            // Si criticité avant = 0, pas de réduction possible (division par zéro)
            if (criticalityBefore === 0) {
                return null;
            }

            const reduction = ((criticalityBefore - criticalityAfter) / criticalityBefore) * 100;
            return Math.round(reduction); // Arrondir à l'entier
        }

        // Génère le badge HTML de réduction du risque
        function getRiskReductionBadge(probBefore, impactBefore, probAfter, impactAfter) {
            const reductionPercent = calculateRiskReduction(probBefore, impactBefore, probAfter, impactAfter);

            // Si non calculable (valeurs non évaluées)
            if (reductionPercent === null) {
                return `<span class="reduction-badge reduction-na">N/A</span>`;
            }

            // Déterminer la classe CSS selon le pourcentage
            let badgeClass = '';
            let emoji = '';
            let label = '';

            if (reductionPercent > 0) {
                // Réduction positive = amélioration
                badgeClass = 'reduction-positive';
                emoji = '📉';
                label = `${reductionPercent}%`;
            } else if (reductionPercent < 0) {
                // Réduction négative = dégradation
                badgeClass = 'reduction-negative';
                emoji = '📈';
                label = `${Math.abs(reductionPercent)}%`;
            } else {
                // Aucun changement
                badgeClass = 'reduction-neutral';
                emoji = '➖';
                label = '0%';
            }

            return `<span class="reduction-badge ${badgeClass}">
                ${emoji} ${label}
            </span>`;
        }

        // Données des risques
        const risks = [
            // Groupe 1: Risques stratégiques
            { id: "1.1", title: "Inadéquation stratégique",
              dtuBefore: [3, 3], dtuAfter: [2, 2],
              gcBefore: [3, 3], gcAfter: [2, 2],
              mesures: ["Révision stratégie trimestrielle", "Alignement objectifs", "Suivi KPI stratégiques"],
              statut: "En cours", responsable: "" },
            { id: "1.2", title: "Déficit de gouvernance",
              dtuBefore: [3, 3], dtuAfter: [2, 2],
              gcBefore: [3, 3], gcAfter: [2, 2],
              mesures: ["Comité de direction élargi", "Processus décisionnels documentés", "Formation gouvernance"],
              statut: "Non traité", responsable: "" },
            { id: "1.3", title: "Résistance au changement",
              dtuBefore: [3, 3], dtuAfter: [2, 2],
              gcBefore: [3, 3], gcAfter: [2, 2],
              mesures: ["Plan de conduite du changement", "Communication interne renforcée", "Formation continue"],
              statut: "Non traité", responsable: "" },

            // Groupe 2: Risques opérationnels
            { id: "2.1", title: "Défaillance processus critique",
              dtuBefore: [3, 4], dtuAfter: [2, 3],
              gcBefore: [3, 4], gcAfter: [2, 3],
              mesures: ["Cartographie processus", "Plans de continuité", "Contrôles renforcés"],
              statut: "En cours", responsable: "" },
            { id: "2.2", title: "Insuffisance ressources",
              dtuBefore: [3, 3], dtuAfter: [2, 2],
              gcBefore: [3, 3], gcAfter: [2, 2],
              mesures: ["Planification ressources", "Mutualisation moyens", "Recrutement ciblé"],
              statut: "Non traité", responsable: "" },
            { id: "2.3", title: "Dysfonctionnement système",
              dtuBefore: [2, 3], dtuAfter: [2, 2],
              gcBefore: [2, 3], gcAfter: [2, 2],
              mesures: ["Maintenance préventive", "Monitoring continu", "Plan de reprise"],
              statut: "Traité", responsable: "" },

            // Groupe 3: Risques externes
            { id: "3.1", title: "Évolution réglementaire",
              dtuBefore: [3, 3], dtuAfter: [2, 2],
              gcBefore: [3, 3], gcAfter: [2, 2],
              mesures: ["Veille réglementaire", "Analyse d'impact", "Adaptation procédures"],
              statut: "En cours", responsable: "" },
            { id: "3.2", title: "Perturbation marché",
              dtuBefore: [3, 3], dtuAfter: [2, 2],
              gcBefore: [3, 3], gcAfter: [2, 2],
              mesures: ["Veille concurrentielle", "Diversification activités", "Agilité organisationnelle"],
              statut: "Non traité", responsable: "" }
        ];
        
        // Groupes de risques avec mesures
        const riskGroups = [
            {
                id: 1,
                name: "Risques stratégiques et organisationnels",
                description: "Stratégie, gouvernance et gestion du changement",
                risks: risks.filter(r => r.id.startsWith("1.")),
                mesures: [
                    "Renforcer la gouvernance et les processus décisionnels",
                    "Développer la communication et la conduite du changement",
                    "Aligner la stratégie avec les objectifs opérationnels",
                    "Mettre en place des indicateurs de performance stratégiques"
                ]
            },
            {
                id: 2,
                name: "Risques opérationnels",
                description: "Processus, ressources et continuité d'activité",
                risks: risks.filter(r => r.id.startsWith("2.")),
                mesures: [
                    "Cartographier et optimiser les processus critiques",
                    "Développer des plans de continuité d'activité",
                    "Renforcer la planification et l'allocation des ressources",
                    "Mettre en place un système de contrôle interne efficace"
                ]
            },
            {
                id: 3,
                name: "Risques externes",
                description: "Environnement réglementaire et marché",
                risks: risks.filter(r => r.id.startsWith("3.")),
                mesures: [
                    "Assurer une veille réglementaire et concurrentielle active",
                    "Développer l'agilité organisationnelle",
                    "Diversifier les activités et sources de revenus",
                    "Anticiper les évolutions du marché"
                ]
            }
        ];
        
        let chartBefore, chartAfter;
        
        // Créer l'interface utilisateur
        // Sauvegarder le mapping des groupes dans localStorage
        function saveGroupMapping() {
            const mapping = riskGroups.map(group => ({
                id: group.id,
                riskIds: group.risks.map(r => r.id)
            }));
            localStorage.setItem('risk-groups-mapping', JSON.stringify(mapping));
        }

        // ========================================
        // Supprimer un groupe
        // ========================================
        function deleteGroup(groupId) {
            // Demander confirmation
            const group = riskGroups.find(g => g.id === groupId);
            if (!group) return;

            const confirmDelete = confirm(`Êtes-vous sûr de vouloir supprimer le groupe "${group.name}" ?\n\nTous les risques de ce groupe seront également supprimés.`);
            if (!confirmDelete) return;

            // Sauvegarder l'état avant modification
            saveState();

            // Supprimer le groupe
            const groupIndex = riskGroups.findIndex(g => g.id === groupId);
            if (groupIndex === -1) return;

            // Supprimer les risques de ce groupe du tableau global
            group.risks.forEach(risk => {
                const riskIndex = risks.findIndex(r => r.id === risk.id);
                if (riskIndex !== -1) {
                    risks.splice(riskIndex, 1);
                }
            });

            // Supprimer le groupe
            riskGroups.splice(groupIndex, 1);

            // Renuméroter tous les groupes restants
            riskGroups.forEach((g, index) => {
                const oldId = g.id;
                const newId = index + 1;

                g.id = newId;

                // Renuméroter les risques de ce groupe
                g.risks.forEach(risk => {
                    const oldRiskId = risk.id;
                    const riskNumber = risk.id.split('.')[1];
                    const newRiskId = `${newId}.${riskNumber}`;

                    // Mettre à jour dans le tableau global risks AVANT de changer risk.id
                    // (car risk pourrait être une référence au même objet)
                    const globalRisk = risks.find(r => r.id === oldRiskId);
                    if (globalRisk) {
                        globalRisk.id = newRiskId;
                    }

                    // Maintenant on peut changer risk.id
                    risk.id = newRiskId;
                });
            });

            // Sauvegarder le nouveau mapping AVANT de re-rendre
            saveGroupMapping();

            // Re-rendre l'interface
            renderRisks();
            updateCharts();

            showToast('✅ Groupe supprimé');
        }

        // ========================================
        // Supprimer un risque
        // ========================================
        function deleteRisk(riskId) {
            // Demander confirmation
            const risk = risks.find(r => r.id === riskId);
            if (!risk) return;

            const confirmDelete = confirm(`Êtes-vous sûr de vouloir supprimer le risque "${risk.title}" ?`);
            if (!confirmDelete) return;

            // Sauvegarder l'état avant modification
            saveState();

            // Trouver le groupe contenant ce risque
            const group = riskGroups.find(g => g.risks.some(r => r.id === riskId));
            if (!group) return;

            // Supprimer le risque du groupe
            const riskIndexInGroup = group.risks.findIndex(r => r.id === riskId);
            if (riskIndexInGroup !== -1) {
                group.risks.splice(riskIndexInGroup, 1);
            }

            // Supprimer le risque du tableau global
            const globalRiskIndex = risks.findIndex(r => r.id === riskId);
            if (globalRiskIndex !== -1) {
                risks.splice(globalRiskIndex, 1);
            }

            // Sauvegarder le nouveau mapping AVANT de re-rendre
            saveGroupMapping();

            // Re-rendre l'interface
            renderRisks();
            updateCharts();

            showToast('✅ Risque supprimé');
        }

        // ========================================
        // Ajouter un nouveau risque à une position spécifique
        // ========================================
        function addNewRiskAtPosition(groupId, position) {
            // Sauvegarder l'état avant modification
            saveState();

            // Trouver le groupe cible
            const group = riskGroups.find(g => g.id === groupId);
            if (!group) return;

            // Créer un nouveau risque
            const newRiskNumber = group.risks.length + 1;
            const newRisk = {
                id: `${groupId}.${newRiskNumber}`,
                title: "Nouveau risque",
                categorie: "Risque organisationnel",
                prob_avant: "Non évalué",
                impact_avant: "Non évalué",
                prob_apres: "Non évalué",
                impact_apres: "Non évalué",
                mesures: [],
                gcBefore: [0, 0],
                gcAfter: [0, 0],
                statut: "Non traité",
                responsable: ""
            };

            // Ajouter le risque au tableau global
            risks.push(newRisk);

            // Insérer le risque dans le groupe à la position spécifiée
            group.risks.splice(position, 0, newRisk);

            // Sauvegarder le nouveau mapping AVANT de re-rendre
            saveGroupMapping();

            // Re-rendre l'interface
            renderRisks();
            updateCharts();

            // Après le rendu, trouver la ligne du nouveau risque et ajouter le highlight
            setTimeout(() => {
                const newRow = document.querySelector(`tr[data-risk-id="${newRisk.id}"]`);
                if (newRow) {
                    newRow.classList.add('newly-added');
                    // Retirer la classe après l'animation
                    setTimeout(() => {
                        newRow.classList.remove('newly-added');
                    }, 2000);
                }
            }, 100);

            // Afficher un toast
            showToast('✅ Nouveau risque ajouté');
        }

        // ========================================
        // Ajouter un nouveau groupe à une position spécifique
        // ========================================
        function addNewGroupAtPosition(position) {
            // Sauvegarder l'état avant modification
            saveState();

            // Créer un risque par défaut pour le nouveau groupe
            // Utiliser un ID temporaire unique pour éviter les collisions pendant la renumération
            const tempId = `temp-${Date.now()}.1`;
            const defaultRisk = {
                id: tempId,
                title: "Nouveau risque",
                categorie: "Risque organisationnel",
                prob_avant: "Non évalué",
                impact_avant: "Non évalué",
                prob_apres: "Non évalué",
                impact_apres: "Non évalué",
                mesures: [],
                gcBefore: [0, 0],
                gcAfter: [0, 0],
                statut: "Non traité",
                responsable: ""
            };

            // Créer un nouveau groupe avec le risque par défaut
            const newGroup = {
                id: 999999, // ID temporaire très élevé pour éviter les collisions
                name: "Nouveau groupe",
                description: "Cliquer pour modifier la description",
                risks: [defaultRisk],
                mesures: []
            };

            // Insérer le nouveau groupe à la position spécifiée
            riskGroups.splice(position, 0, newGroup);

            // Ajouter le nouveau risque au tableau global AVANT la renumération
            risks.push(defaultRisk);

            // Renuméroter tous les groupes dans l'ordre
            riskGroups.forEach((group, index) => {
                const oldId = group.id;
                const newId = index + 1;

                // Mettre à jour l'ID du groupe
                group.id = newId;

                // Renuméroter les risques de ce groupe
                group.risks.forEach(risk => {
                    // Changer "oldId.X" en "newId.X"
                    const oldRiskId = risk.id;
                    const riskNumber = risk.id.split('.')[1];
                    const newRiskId = `${newId}.${riskNumber}`;

                    // Mettre à jour dans le tableau global risks AVANT de changer risk.id
                    // (car risk pourrait être une référence au même objet)
                    const globalRisk = risks.find(r => r.id === oldRiskId);
                    if (globalRisk) {
                        globalRisk.id = newRiskId;
                    }

                    // Maintenant on peut changer risk.id
                    risk.id = newRiskId;
                });
            });

            // Sauvegarder le nouveau mapping AVANT de re-rendre
            saveGroupMapping();

            // Re-rendre l'interface
            renderRisks();
            updateCharts();

            // Afficher un toast
            showToast('✅ Nouveau groupe ajouté');
        }

        // Restaurer le mapping des groupes depuis localStorage (appelé UNE SEULE FOIS à l'initialisation)
        function restoreGroupMappingFromStorage() {
            const savedMapping = localStorage.getItem('risk-groups-mapping');
            if (savedMapping) {
                try {
                    const mapping = JSON.parse(savedMapping);
                    mapping.forEach(groupMap => {
                        const group = riskGroups.find(g => g.id == groupMap.id);
                        if (group) {
                            // Reconstruire le tableau des risques du groupe
                            group.risks = groupMap.riskIds
                                .map(riskId => risks.find(r => r.id === riskId))
                                .filter(r => r !== undefined);
                        }
                    });
                    console.log('✅ Mapping des groupes restauré depuis localStorage');
                } catch (e) {
                    console.error('❌ Erreur lors de la restauration du mapping des groupes:', e);
                }
            }
        }

        // Mettre à jour une ligne de risque quand les dropdowns changent
        function updateRiskRow(riskIndex) {
            // Récupérer les valeurs actuelles des dropdowns
            const probBeforeElem = document.getElementById(`gc-prob-before-${riskIndex}`);
            const impactBeforeElem = document.getElementById(`gc-impact-before-${riskIndex}`);
            const probAfterElem = document.getElementById(`gc-prob-after-${riskIndex}`);
            const impactAfterElem = document.getElementById(`gc-impact-after-${riskIndex}`);

            if (!probBeforeElem || !impactBeforeElem || !probAfterElem || !impactAfterElem) {
                console.warn(`Impossible de trouver les éléments pour le risque ${riskIndex}`);
                updateCharts();
                return;
            }

            const probBefore = parseInt(probBeforeElem.value);
            const impactBefore = parseInt(impactBeforeElem.value);
            const probAfter = parseInt(probAfterElem.value);
            const impactAfter = parseInt(impactAfterElem.value);

            // Mettre à jour les badges de criticité
            const critBeforeCell = document.getElementById(`crit-before-${riskIndex}`);
            const critAfterCell = document.getElementById(`crit-after-${riskIndex}`);
            const reductionCell = document.getElementById(`reduction-${riskIndex}`);

            if (critBeforeCell) {
                critBeforeCell.innerHTML = getCriticalityBadge(probBefore, impactBefore);
            }

            if (critAfterCell) {
                critAfterCell.innerHTML = getCriticalityBadge(probAfter, impactAfter);
            }

            if (reductionCell) {
                reductionCell.innerHTML = getRiskReductionBadge(probBefore, impactBefore, probAfter, impactAfter);
            }

            // Mettre à jour les matrices et le dashboard
            updateCharts();
        }

        function renderRisks() {
            const container = document.getElementById('risks-container');
            container.innerHTML = '';

            // Si aucun groupe, ajouter au moins un séparateur initial
            if (riskGroups.length === 0) {
                const initialSeparator = document.createElement('div');
                initialSeparator.className = 'group-separator';
                initialSeparator.dataset.insertPosition = '0';
                initialSeparator.innerHTML = `
                    <div class="group-separator-label">
                        <span class="group-separator-icon">+</span>
                        <span>${t('addGroup')}</span>
                    </div>
                `;
                initialSeparator.addEventListener('click', () => {
                    addNewGroupAtPosition(0);
                });
                container.appendChild(initialSeparator);

                // Initialiser quand même les fonctions
                initDragAndDrop();
                initRiskTitleEditing();
                initRemediationEditing();
                initStatusDropdowns();
                initResponsableEditing();
                return;
            }

            riskGroups.forEach((group, groupIndex) => {
                // Ajouter un séparateur AVANT chaque groupe
                const separator = document.createElement('div');
                separator.className = 'group-separator';
                separator.dataset.insertPosition = groupIndex; // Position où insérer le nouveau groupe
                separator.innerHTML = `
                    <div class="group-separator-label">
                        <span class="group-separator-icon">+</span>
                        <span>${t('addGroup')}</span>
                    </div>
                `;
                separator.addEventListener('click', () => {
                    const position = parseInt(separator.dataset.insertPosition);
                    addNewGroupAtPosition(position);
                });
                container.appendChild(separator);

                const groupDiv = document.createElement('div');
                groupDiv.className = 'risk-group collapsible-section';

                // En-tête du groupe (collapsable)
                const headerDiv = document.createElement('h2');
                headerDiv.className = 'collapsible-header risk-group-header-collapsible';
                headerDiv.onclick = (e) => {
                    // Ne pas fermer/ouvrir si on clique sur le bouton de suppression
                    if (e.target.closest('.delete-btn')) return;
                    toggleCollapse(`group-content-${group.id}`);
                };
                headerDiv.innerHTML = `
                    <span class="collapse-icon">▼</span>
                    <div class="risk-group-number">${group.id}</div>
                    <div style="flex: 1;">
                        <div class="risk-group-title editable-group-name" id="group-name-${group.id}" data-group-id="${group.id}">${group.name}</div>
                        <div class="risk-group-description editable-group-description" id="group-desc-${group.id}" data-group-id="${group.id}">${group.description}</div>
                    </div>
                `;

                // Ajouter le bouton de suppression
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = `<span>🗑️</span><span>${t('deleteGroup')}</span>`;
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteGroup(group.id);
                };
                headerDiv.appendChild(deleteBtn);

                groupDiv.appendChild(headerDiv);

                // Contenu collapsable du groupe - Tableau des risques
                const contentDiv = document.createElement('div');
                contentDiv.id = `group-content-${group.id}`;
                contentDiv.className = 'collapsible-content';

                // Créer un wrapper pour le scroll horizontal (styles en CSS)
                const tableWrapper = document.createElement('div');
                tableWrapper.className = 'table-scroll-wrapper';

                // Créer un tableau pour les risques
                const table = document.createElement('table');
                table.className = 'risks-table';
                table.innerHTML = `
                    <colgroup>
                        <col style="width: 22%">
                        <col style="width: 7%">
                        <col style="width: 7%">
                        <col style="width: 10%">
                        <col style="width: 7%">
                        <col style="width: 7%">
                        <col style="width: 10%">
                        <col style="width: 10%">
                        <col style="width: 10%">
                        <col style="width: 8%">
                        <col style="width: 2%">
                    </colgroup>
                    <thead>
                        <tr>
                            <th rowspan="2">${t('colRisk')}</th>
                            <th colspan="3" style="text-align: center;">${t('colBefore')}</th>
                            <th colspan="3" style="text-align: center;">${t('colAfter')}</th>
                            <th rowspan="2">${t('colReduction')}</th>
                            <th rowspan="2">${t('colStatus')}</th>
                            <th rowspan="2">${t('colResp')}</th>
                            <th rowspan="2" style="width: 40px;"></th>
                        </tr>
                        <tr>
                            <th style="font-size: 11px;">${t('colProb')}</th>
                            <th style="font-size: 11px;">${t('colImpact')}</th>
                            <th style="font-size: 11px;">${t('colCriticality')}</th>
                            <th style="font-size: 11px;">${t('colProb')}</th>
                            <th style="font-size: 11px;">${t('colImpact')}</th>
                            <th style="font-size: 11px;">${t('colCriticality')}</th>
                        </tr>
                    </thead>
                    <tbody id="group-${group.id}-risks" data-group-id="${group.id}">
                    </tbody>
                `;

                const tbody = table.querySelector('tbody');

                // Si aucun risque, ajouter au moins un séparateur
                if (group.risks.length === 0) {
                    const separatorTr = document.createElement('tr');
                    separatorTr.className = 'risk-separator-row';
                    separatorTr.innerHTML = `
                        <td colspan="11">
                            <div class="risk-separator" data-group-id="${group.id}" data-risk-position="0">
                                <div class="risk-separator-label">
                                    <span class="risk-separator-icon">+</span>
                                    <span>${t('addRisk')}</span>
                                </div>
                            </div>
                        </td>
                    `;
                    const separator = separatorTr.querySelector('.risk-separator');
                    separator.addEventListener('click', () => {
                        addNewRiskAtPosition(group.id, 0);
                    });
                    tbody.appendChild(separatorTr);
                } else {
                    // Risques du groupe avec séparateurs
                    group.risks.forEach((risk, localIndex) => {
                        // Ajouter un séparateur AVANT chaque risque
                        const separatorTr = document.createElement('tr');
                        separatorTr.className = 'risk-separator-row';
                        separatorTr.innerHTML = `
                            <td colspan="11">
                                <div class="risk-separator" data-group-id="${group.id}" data-risk-position="${localIndex}">
                                    <div class="risk-separator-label">
                                        <span class="risk-separator-icon">+</span>
                                        <span>${t('addRisk')}</span>
                                    </div>
                                </div>
                            </td>
                        `;
                        const separator = separatorTr.querySelector('.risk-separator');
                        separator.addEventListener('click', () => {
                            addNewRiskAtPosition(group.id, localIndex);
                        });
                        tbody.appendChild(separatorTr);

                        // Ajouter le risque
                        const index = risks.findIndex(r => r.id === risk.id);
                        const tr = document.createElement('tr');
                        tr.draggable = true;
                        tr.dataset.riskId = risk.id;
                        tr.dataset.riskIndex = index;

                        // Ajouter classe pour alternance de couleurs
                        tr.className = localIndex % 2 === 0 ? 'risk-even' : 'risk-odd';

                        const mesuresText = risk.mesures && risk.mesures.length > 0
                            ? risk.mesures.join(' • ')
                            : t('clickToAddRemediation');

                        tr.innerHTML = `
                            <td class="risk-title-cell">
                                <span class="expand-icon" data-risk-id="${risk.id}">▼</span>
                                <span class="editable-risk-title" data-risk-id="${risk.id}">${risk.id}. ${risk.title}</span>
                            </td>
                            <td class="dropdown-single-cell">
                                <select id="gc-prob-before-${index}" onchange="updateRiskRow(${index})">
                                    ${generateOptions(getProbabilityScale(), risk.gcBefore[0])}
                                </select>
                            </td>
                            <td class="dropdown-single-cell">
                                <select id="gc-impact-before-${index}" onchange="updateRiskRow(${index})">
                                    ${generateOptions(getImpactScale(), risk.gcBefore[1])}
                                </select>
                            </td>
                            <td class="criticality-cell" id="crit-before-${index}">
                                ${getCriticalityBadge(risk.gcBefore[0], risk.gcBefore[1])}
                            </td>
                            <td class="dropdown-single-cell">
                                <select id="gc-prob-after-${index}" onchange="updateRiskRow(${index})">
                                    ${generateOptions(getProbabilityScale(), risk.gcAfter[0])}
                                </select>
                            </td>
                            <td class="dropdown-single-cell">
                                <select id="gc-impact-after-${index}" onchange="updateRiskRow(${index})">
                                    ${generateOptions(getImpactScale(), risk.gcAfter[1])}
                                </select>
                            </td>
                            <td class="criticality-cell" id="crit-after-${index}">
                                ${getCriticalityBadge(risk.gcAfter[0], risk.gcAfter[1])}
                            </td>
                            <td class="reduction-cell" id="reduction-${index}">
                                ${getRiskReductionBadge(risk.gcBefore[0], risk.gcBefore[1], risk.gcAfter[0], risk.gcAfter[1])}
                            </td>
                            <td class="status-cell">
                                <select id="status-${index}" data-risk-id="${risk.id}" class="status-dropdown">
                                    ${generateStatusOptions(risk.statut)}
                                </select>
                            </td>
                            <td class="responsable-cell">
                                <span class="editable-responsable" data-risk-id="${risk.id}">${risk.responsable || t('clickToAdd')}</span>
                            </td>
                            <td style="text-align: center; padding: 4px;">
                                <button class="delete-btn delete-risk-btn" onclick="deleteRisk('${risk.id}')" title="Supprimer ce risque">🗑️</button>
                            </td>
                        `;

                        tbody.appendChild(tr);

                        // Ajouter la ligne dépliable pour les remédiations
                        const remediationRow = document.createElement('tr');
                        remediationRow.className = localIndex % 2 === 0 ? 'remediation-row risk-even' : 'remediation-row risk-odd';
                        remediationRow.id = `remediation-row-${risk.id}`;
                        remediationRow.innerHTML = `
                            <td colspan="11" class="remediation-cell-expanded">
                                <div class="remediation-content">
                                    <strong>${t('colRemediations')}:</strong>
                                    <span class="editable-remediation" data-risk-id="${risk.id}">${mesuresText}</span>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(remediationRow);

                        // Ajouter le handler pour le toggle expand/collapse
                        const expandIcon = tr.querySelector('.expand-icon');
                        expandIcon.addEventListener('click', () => {
                            const isCollapsed = remediationRow.classList.contains('collapsed');
                            if (isCollapsed) {
                                remediationRow.classList.remove('collapsed');
                                expandIcon.textContent = '▼';
                            } else {
                                remediationRow.classList.add('collapsed');
                                expandIcon.textContent = '▶';
                            }
                        });
                    });

                    // Ajouter un séparateur APRÈS le dernier risque
                    const finalSeparatorTr = document.createElement('tr');
                    finalSeparatorTr.className = 'risk-separator-row';
                    finalSeparatorTr.innerHTML = `
                        <td colspan="11">
                            <div class="risk-separator" data-group-id="${group.id}" data-risk-position="${group.risks.length}">
                                <div class="risk-separator-label">
                                    <span class="risk-separator-icon">+</span>
                                    <span>${t('addRisk')}</span>
                                </div>
                            </div>
                        </td>
                    `;
                    const finalSeparator = finalSeparatorTr.querySelector('.risk-separator');
                    finalSeparator.addEventListener('click', () => {
                        addNewRiskAtPosition(group.id, group.risks.length);
                    });
                    tbody.appendChild(finalSeparatorTr);
                }

                // Ajouter le tableau dans le wrapper de scroll
                tableWrapper.appendChild(table);

                // Ajouter le wrapper dans le contenu
                contentDiv.appendChild(tableWrapper);

                // Ajouter le contenu collapsable au groupe
                groupDiv.appendChild(contentDiv);

                // Restaurer l'état du collapse depuis localStorage
                const isCollapsed = localStorage.getItem(`collapse-group-content-${group.id}`) === 'true';
                if (isCollapsed) {
                    headerDiv.classList.add('collapsed');
                    contentDiv.classList.add('collapsed');
                }

                container.appendChild(groupDiv);
            });

            // Ajouter un dernier séparateur APRÈS le dernier groupe
            const finalSeparator = document.createElement('div');
            finalSeparator.className = 'group-separator';
            finalSeparator.dataset.insertPosition = riskGroups.length; // Position à la fin
            finalSeparator.innerHTML = `
                <div class="group-separator-label">
                    <span class="group-separator-icon">+</span>
                    <span>${t('addGroup')}</span>
                </div>
            `;
            finalSeparator.addEventListener('click', () => {
                const position = parseInt(finalSeparator.dataset.insertPosition);
                addNewGroupAtPosition(position);
            });
            container.appendChild(finalSeparator);

            // Initialiser le drag & drop et l'édition inline après le rendu
            initDragAndDrop();
            initRiskTitleEditing();
            initRemediationEditing();
            initStatusDropdowns();
                initResponsableEditing();
        }

        // ========================================
        // Système de Drag & Drop pour les risques
        // ========================================

        let draggedRow = null;

        function initDragAndDrop() {
            // Seulement les lignes de risques sont draggables, pas les lignes de remédiations
            const rows = document.querySelectorAll('.risks-table tbody tr:not(.risk-separator-row):not(.remediation-row)');

            rows.forEach(row => {
                row.addEventListener('dragstart', handleDragStart);
                row.addEventListener('dragend', handleDragEnd);
                // Plus de drop sur les risques, uniquement sur les séparateurs
            });

            // Les séparateurs peuvent aussi recevoir les drops
            const separators = document.querySelectorAll('.risks-table tbody tr.risk-separator-row');
            separators.forEach(sep => {
                sep.addEventListener('dragover', handleSeparatorDragOver);
                sep.addEventListener('drop', handleSeparatorDrop);
                sep.addEventListener('dragleave', handleSeparatorDragLeave);
            });
        }

        function handleDragStart(e) {
            draggedRow = this;
            this.classList.add('dragging');

            // Ajouter aussi la classe 'dragging' à la ligne de remédiation associée
            const riskId = this.dataset.riskId;
            const remediationRow = document.getElementById(`remediation-row-${riskId}`);
            if (remediationRow) {
                remediationRow.classList.add('dragging');
            }

            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');

            // Retirer aussi la classe 'dragging' de la ligne de remédiation associée
            const riskId = this.dataset.riskId;
            const remediationRow = document.getElementById(`remediation-row-${riskId}`);
            if (remediationRow) {
                remediationRow.classList.remove('dragging');
            }

            // Retirer tous les indicateurs de drop
            document.querySelectorAll('.risks-table tbody tr:not(.risk-separator-row)').forEach(row => {
                row.classList.remove('drag-over-top', 'drag-over-bottom');
            });

            // Retirer aussi l'indicateur des séparateurs
            document.querySelectorAll('.risks-table tbody tr.risk-separator-row').forEach(row => {
                row.classList.remove('separator-drag-over');
            });
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';

            // Ajouter l'indicateur visuel
            if (draggedRow !== this) {
                // Déterminer si on monte ou on descend
                const tbody = this.closest('tbody');
                const allRiskRows = Array.from(tbody.querySelectorAll('tr[data-risk-id]'));
                const draggedIndex = allRiskRows.indexOf(draggedRow);
                const targetIndex = allRiskRows.indexOf(this);

                // Retirer les anciennes classes
                this.classList.remove('drag-over-top', 'drag-over-bottom');

                if (draggedIndex < targetIndex) {
                    // On descend : marqueur en bas du target
                    this.classList.add('drag-over-bottom');
                } else {
                    // On monte : marqueur en haut du target
                    this.classList.add('drag-over-top');
                }
            }

            return false;
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over-top', 'drag-over-bottom');
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            this.classList.remove('drag-over-top', 'drag-over-bottom');

            if (draggedRow !== this) {
                const sourceGroupId = draggedRow.closest('tbody').dataset.groupId;
                const targetGroupId = this.closest('tbody').dataset.groupId;
                const draggedRiskId = draggedRow.dataset.riskId;
                const targetRiskId = this.dataset.riskId;

                // Récupérer la ligne de remédiation associée au risque déplacé
                const draggedRemediationRow = document.getElementById(`remediation-row-${draggedRiskId}`);

                // Déplacer physiquement les deux lignes dans le DOM
                const targetRow = this;
                const tbody = targetRow.closest('tbody');

                // Trouver la position d'insertion (avant ou après le target selon la direction)
                const allRiskRows = Array.from(tbody.querySelectorAll('tr[data-risk-id]'));
                const draggedIndex = allRiskRows.indexOf(draggedRow);
                const targetIndex = allRiskRows.indexOf(targetRow);

                if (draggedIndex < targetIndex) {
                    // Déplacement vers le bas : insérer APRÈS le target
                    if (targetRow.nextElementSibling) {
                        // Si le target a une ligne de remédiation après lui, insérer après cette ligne
                        const targetRemediationRow = document.getElementById(`remediation-row-${targetRiskId}`);
                        if (targetRemediationRow && targetRemediationRow.nextElementSibling) {
                            tbody.insertBefore(draggedRow, targetRemediationRow.nextElementSibling);
                            tbody.insertBefore(draggedRemediationRow, targetRemediationRow.nextElementSibling);
                        } else {
                            tbody.appendChild(draggedRow);
                            tbody.appendChild(draggedRemediationRow);
                        }
                    } else {
                        tbody.appendChild(draggedRow);
                        tbody.appendChild(draggedRemediationRow);
                    }
                } else {
                    // Déplacement vers le haut : insérer AVANT le target
                    tbody.insertBefore(draggedRow, targetRow);
                    tbody.insertBefore(draggedRemediationRow, targetRow);
                }

                // Mettre à jour la structure de données
                moveRiskBetweenGroups(draggedRiskId, sourceGroupId, targetGroupId, targetRiskId);

                // Re-render tout le tableau pour recréer les séparateurs et numérotation
                renderRisks();
                initGroupNameEditing();
                initGroupDescriptionEditing();
                initRiskTitleEditing();
                initRemediationEditing();
                initStatusDropdowns();
                initResponsableEditing();
                initSectionTitleEditing();

                // Rafraîchir les graphiques
                updateCharts();

                console.log(`✅ Risque ${draggedRiskId} déplacé du groupe ${sourceGroupId} vers le groupe ${targetGroupId}`);
            }

            return false;
        }

        // Gestion du drag sur les séparateurs (interstices entre les risques)
        function handleSeparatorDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';

            // Ajouter l'indicateur visuel sur le séparateur
            this.classList.add('separator-drag-over');

            return false;
        }

        function handleSeparatorDragLeave(e) {
            this.classList.remove('separator-drag-over');
        }

        function handleSeparatorDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            this.classList.remove('separator-drag-over');

            if (draggedRow) {
                const separator = this.querySelector('.risk-separator');
                const targetGroupId = separator.dataset.groupId;
                const targetPosition = parseInt(separator.dataset.riskPosition);
                const sourceGroupId = draggedRow.closest('tbody').dataset.groupId;
                const draggedRiskId = draggedRow.dataset.riskId;

                console.log(`📍 Drop sur séparateur : position ${targetPosition} dans groupe ${targetGroupId}`);

                // Déplacer le risque à la position exacte du séparateur
                moveRiskToPosition(draggedRiskId, sourceGroupId, targetGroupId, targetPosition);

                // Re-render tout le tableau
                renderRisks();
                initGroupNameEditing();
                initGroupDescriptionEditing();
                initRiskTitleEditing();
                initRemediationEditing();
                initStatusDropdowns();
                initResponsableEditing();
                initSectionTitleEditing();

                // Rafraîchir les graphiques
                updateCharts();

                console.log(`✅ Risque ${draggedRiskId} inséré à la position ${targetPosition} dans groupe ${targetGroupId}`);
            }

            return false;
        }

        function moveRiskToPosition(riskId, sourceGroupId, targetGroupId, targetPosition) {
            console.log(`🔧 moveRiskToPosition: risque=${riskId}, source=${sourceGroupId}, target=${targetGroupId}, position=${targetPosition}`);

            // Trouver le risque dans le tableau global
            const risk = risks.find(r => r.id === riskId);
            if (!risk) {
                console.error(`❌ Risque ${riskId} non trouvé`);
                return;
            }

            // Trouver les groupes source et cible
            const sourceGroup = riskGroups.find(g => g.id == sourceGroupId);
            const targetGroup = riskGroups.find(g => g.id == targetGroupId);

            if (!sourceGroup || !targetGroup) {
                console.error(`❌ Groupe source ou cible non trouvé`);
                return;
            }

            console.log(`📊 AVANT: groupe ${targetGroupId} a ${targetGroup.risks.length} risques:`, targetGroup.risks.map(r => r.id));

            // Si on déplace dans le même groupe, ajuster la position
            let adjustedPosition = targetPosition;
            if (sourceGroupId === targetGroupId) {
                // Trouver la position actuelle du risque AVANT de le retirer
                const originalIndex = sourceGroup.risks.findIndex(r => r.id === riskId);
                console.log(`🔄 Même groupe: originalIndex=${originalIndex}, targetPosition=${targetPosition}`);
                if (originalIndex !== -1 && originalIndex < targetPosition) {
                    adjustedPosition = targetPosition - 1;
                    console.log(`⚡ Position ajustée: ${targetPosition} → ${adjustedPosition}`);
                }
            }

            // Retirer le risque du groupe source
            sourceGroup.risks = sourceGroup.risks.filter(r => r.id !== riskId);
            console.log(`➖ Risque retiré du groupe source`);

            // Insérer le risque à la position exacte dans le groupe cible
            targetGroup.risks.splice(adjustedPosition, 0, risk);
            console.log(`➕ Risque inséré à la position ${adjustedPosition}`);
            console.log(`📊 APRÈS: groupe ${targetGroupId} a ${targetGroup.risks.length} risques:`, targetGroup.risks.map(r => r.id));

            // Sauvegarder le mapping
            saveGroupMapping();
            console.log(`💾 Mapping sauvegardé`);
        }

        function moveRiskBetweenGroups(riskId, sourceGroupId, targetGroupId, targetRiskId = null) {
            // Trouver le risque dans le tableau global
            const risk = risks.find(r => r.id === riskId);
            if (!risk) return;

            // Trouver les groupes source et cible
            const sourceGroup = riskGroups.find(g => g.id == sourceGroupId);
            const targetGroup = riskGroups.find(g => g.id == targetGroupId);

            if (!sourceGroup || !targetGroup) return;

            // Retirer le risque du groupe source
            sourceGroup.risks = sourceGroup.risks.filter(r => r.id !== riskId);

            // Ajouter le risque au groupe cible à la bonne position
            if (!targetGroup.risks.find(r => r.id === riskId)) {
                if (targetRiskId) {
                    // Insérer à la position du target
                    const targetIndex = targetGroup.risks.findIndex(r => r.id === targetRiskId);
                    if (targetIndex !== -1) {
                        // Insérer après le target si on descend, avant si on monte
                        const currentTargetIndex = targetGroup.risks.findIndex(r => r.id === targetRiskId);
                        targetGroup.risks.splice(currentTargetIndex + 1, 0, risk);
                    } else {
                        targetGroup.risks.push(risk);
                    }
                } else {
                    // Si pas de target spécifique, ajouter à la fin
                    targetGroup.risks.push(risk);
                }
            }

            // Sauvegarder le mapping
            saveGroupMapping();
        }

        // Lire les valeurs des formulaires
        function getCurrentRisks() {
            return risks.map((risk, index) => {
                // Vérifier que les éléments existent dans le DOM
                const probBeforeElem = document.getElementById(`gc-prob-before-${index}`);
                const impactBeforeElem = document.getElementById(`gc-impact-before-${index}`);
                const probAfterElem = document.getElementById(`gc-prob-after-${index}`);
                const impactAfterElem = document.getElementById(`gc-impact-after-${index}`);

                // Si les éléments n'existent pas encore, utiliser les valeurs du risque
                const gcProbBefore = probBeforeElem ? parseInt(probBeforeElem.value) : risk.gcBefore[0];
                const gcImpactBefore = impactBeforeElem ? parseInt(impactBeforeElem.value) : risk.gcBefore[1];
                const gcProbAfter = probAfterElem ? parseInt(probAfterElem.value) : risk.gcAfter[0];
                const gcImpactAfter = impactAfterElem ? parseInt(impactAfterElem.value) : risk.gcAfter[1];

                return {
                    ...risk,
                    dtuBefore: [gcProbBefore, gcImpactBefore],  // Utiliser G&C pour DTU
                    dtuAfter: [gcProbAfter, gcImpactAfter],      // Utiliser G&C pour DTU
                    gcBefore: [gcProbBefore, gcImpactBefore],
                    gcAfter: [gcProbAfter, gcImpactAfter]
                };
            });
        }
        
        // Plugin pour dessiner la matrice de couleurs en arrière-plan
        const matrixBackgroundPlugin = {
            id: 'matrixBackground',
            beforeDatasetsDraw: (chart) => {
                const { ctx, chartArea: { left, top, width, height }, scales: { x, y } } = chart;

                // Matrice 5×5 complète avec carrés égaux
                // Criticité = P×I : 1-4 vert, 5-9 jaune, 10-14 orange, 15-25 rouge
                const zones = [
                    // Impact 5 (ligne du haut)
                    { xMin: 0.5, xMax: 1.5, yMin: 4.5, yMax: 5.5, color: '#E8F5E9' },  // P=1, I=5, Crit=5 (vert pâle)
                    { xMin: 1.5, xMax: 2.5, yMin: 4.5, yMax: 5.5, color: '#FFE699' },  // P=2, I=5, Crit=10 (orange)
                    { xMin: 2.5, xMax: 3.5, yMin: 4.5, yMax: 5.5, color: '#F4B183' },  // P=3, I=5, Crit=15 (rouge)
                    { xMin: 3.5, xMax: 4.5, yMin: 4.5, yMax: 5.5, color: '#FFC7CE' },  // P=4, I=5, Crit=20 (rouge)
                    { xMin: 4.5, xMax: 5.5, yMin: 4.5, yMax: 5.5, color: '#FFC7CE' },  // P=5, I=5, Crit=25 (rouge)

                    // Impact 4
                    { xMin: 0.5, xMax: 1.5, yMin: 3.5, yMax: 4.5, color: '#C5E0B3' },  // P=1, I=4, Crit=4 (vert)
                    { xMin: 1.5, xMax: 2.5, yMin: 3.5, yMax: 4.5, color: '#FFE699' },  // P=2, I=4, Crit=8 (jaune)
                    { xMin: 2.5, xMax: 3.5, yMin: 3.5, yMax: 4.5, color: '#F4B183' },  // P=3, I=4, Crit=12 (orange)
                    { xMin: 3.5, xMax: 4.5, yMin: 3.5, yMax: 4.5, color: '#FFC7CE' },  // P=4, I=4, Crit=16 (rouge)
                    { xMin: 4.5, xMax: 5.5, yMin: 3.5, yMax: 4.5, color: '#FFC7CE' },  // P=5, I=4, Crit=20 (rouge)

                    // Impact 3
                    { xMin: 0.5, xMax: 1.5, yMin: 2.5, yMax: 3.5, color: '#C5E0B3' },  // P=1, I=3, Crit=3 (vert)
                    { xMin: 1.5, xMax: 2.5, yMin: 2.5, yMax: 3.5, color: '#E8F5E9' },  // P=2, I=3, Crit=6 (vert pâle)
                    { xMin: 2.5, xMax: 3.5, yMin: 2.5, yMax: 3.5, color: '#FFE699' },  // P=3, I=3, Crit=9 (jaune)
                    { xMin: 3.5, xMax: 4.5, yMin: 2.5, yMax: 3.5, color: '#F4B183' },  // P=4, I=3, Crit=12 (orange)
                    { xMin: 4.5, xMax: 5.5, yMin: 2.5, yMax: 3.5, color: '#FFC7CE' },  // P=5, I=3, Crit=15 (rouge)

                    // Impact 2
                    { xMin: 0.5, xMax: 1.5, yMin: 1.5, yMax: 2.5, color: '#C5E0B3' },  // P=1, I=2, Crit=2 (vert)
                    { xMin: 1.5, xMax: 2.5, yMin: 1.5, yMax: 2.5, color: '#C5E0B3' },  // P=2, I=2, Crit=4 (vert)
                    { xMin: 2.5, xMax: 3.5, yMin: 1.5, yMax: 2.5, color: '#E8F5E9' },  // P=3, I=2, Crit=6 (vert pâle)
                    { xMin: 3.5, xMax: 4.5, yMin: 1.5, yMax: 2.5, color: '#FFE699' },  // P=4, I=2, Crit=8 (jaune)
                    { xMin: 4.5, xMax: 5.5, yMin: 1.5, yMax: 2.5, color: '#F4B183' },  // P=5, I=2, Crit=10 (orange)

                    // Impact 1
                    { xMin: 0.5, xMax: 1.5, yMin: 0.5, yMax: 1.5, color: '#C5E0B3' },  // P=1, I=1, Crit=1 (vert)
                    { xMin: 1.5, xMax: 2.5, yMin: 0.5, yMax: 1.5, color: '#C5E0B3' },  // P=2, I=1, Crit=2 (vert)
                    { xMin: 2.5, xMax: 3.5, yMin: 0.5, yMax: 1.5, color: '#C5E0B3' },  // P=3, I=1, Crit=3 (vert)
                    { xMin: 3.5, xMax: 4.5, yMin: 0.5, yMax: 1.5, color: '#C5E0B3' },  // P=4, I=1, Crit=4 (vert)
                    { xMin: 4.5, xMax: 5.5, yMin: 0.5, yMax: 1.5, color: '#E8F5E9' }   // P=5, I=1, Crit=5 (vert pâle)
                ];

                ctx.save();

                zones.forEach(zone => {
                    const xStart = x.getPixelForValue(zone.xMin);
                    const xEnd = x.getPixelForValue(zone.xMax);
                    const yStart = y.getPixelForValue(zone.yMax);
                    const yEnd = y.getPixelForValue(zone.yMin);

                    // Remplir le carré avec la couleur
                    ctx.fillStyle = zone.color;
                    ctx.fillRect(xStart, yStart, xEnd - xStart, yEnd - yStart);

                    // Dessiner la bordure blanche
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(xStart, yStart, xEnd - xStart, yEnd - yStart);
                });

                ctx.restore();
            }
        };
        
        // Plugin pour afficher les numéros de groupes sur les points
        const riskLabelsPlugin = {
            id: 'riskLabels',
            afterDatasetsDraw: (chart) => {
                const { ctx, data, scales: { x, y } } = chart;

                ctx.save();
                ctx.font = 'bold 13px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                data.datasets[0].data.forEach((point, index) => {
                    const xPos = x.getPixelForValue(point.x);
                    const yPos = y.getPixelForValue(point.y);

                    // Afficher le numéro du groupe
                    const num = index + 1; // Numéros de groupe 1 à 5

                    ctx.fillStyle = 'white';
                    ctx.fillText(num, xPos, yPos);
                });

                ctx.restore();
            }
        };
        
        // Créer un graphique de risque
        function createRiskChart(ctx, data, title) {
            return new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Risques',
                        data: data,
                        backgroundColor: '#1F4E78',
                        borderColor: 'white',
                        borderWidth: 1.5,
                        pointRadius: 10,
                        pointHoverRadius: 12,
                        pointStyle: 'circle'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1, // Force le graphique à être carré
                    animation: false, // Désactiver toutes les animations
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleFont: { size: 13, weight: 'bold' },
                            bodyFont: { size: 12 },
                            padding: 10,
                            callbacks: {
                                title: function(context) {
                                    const point = context[0].raw;
                                    return point.label;
                                },
                                label: function(context) {
                                    const point = context.raw;
                                    // Utiliser les valeurs de base (sans jitter) pour l'affichage
                                    const realX = point.baseX || point.x;
                                    const realY = point.baseY || point.y;
                                    const criticality = realX * realY;
                                    return [
                                        `${point.groupName}`,
                                        `Probabilité: ${realX.toFixed(2)}`,
                                        `Impact: ${realY.toFixed(2)}`,
                                        `Criticité: ${criticality.toFixed(1)}/16`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            min: 0.5,
                            max: 5.5,
                            ticks: {
                                stepSize: 1,
                                font: {
                                    size: 12
                                },
                                callback: function(value) {
                                    // Afficher seulement les valeurs entières 1-5
                                    return (value >= 1 && value <= 5 && Number.isInteger(value)) ? value : '';
                                }
                            },
                            grid: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Probabilité →',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        },
                        y: {
                            min: 0.5,
                            max: 5.5,
                            ticks: {
                                stepSize: 1,
                                font: {
                                    size: 12
                                },
                                callback: function(value) {
                                    // Afficher seulement les valeurs entières 1-5
                                    return (value >= 1 && value <= 5 && Number.isInteger(value)) ? value : '';
                                }
                            },
                            grid: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Impact →',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                },
                plugins: [matrixBackgroundPlugin, riskLabelsPlugin]
            });
        }
        
        // Mettre à jour le tableau des risques individuels
        function updateRiskTable(currentRisks) {
            const tableBody = document.getElementById('risk-table-body');
            tableBody.innerHTML = '';
            
            riskGroups.forEach(group => {
                group.risks.forEach(risk => {
                    const currentRisk = currentRisks.find(r => r.id === risk.id);
                    if (!currentRisk) return;
                    
                    const row = document.createElement('tr');
                    
                    // Calculer les moyennes DTU & G&C
                    const avgProbBefore = (currentRisk.dtuBefore[0] + currentRisk.gcBefore[0]) / 2;
                    const avgImpactBefore = (currentRisk.dtuBefore[1] + currentRisk.gcBefore[1]) / 2;
                    const avgCritBefore = avgProbBefore * avgImpactBefore;
                    
                    const avgProbAfter = (currentRisk.dtuAfter[0] + currentRisk.gcAfter[0]) / 2;
                    const avgImpactAfter = (currentRisk.dtuAfter[1] + currentRisk.gcAfter[1]) / 2;
                    const avgCritAfter = avgProbAfter * avgImpactAfter;
                    
                    function getCritClass(crit) {
                        if (crit <= 4) return 'criticality-low';
                        if (crit <= 9) return 'criticality-medium';
                        if (crit <= 11) return 'criticality-high';
                        return 'criticality-critical';
                    }
                    
                    row.innerHTML = `
                        <td>${currentRisk.id}</td>
                        <td>${currentRisk.title}</td>
                        <td>
                            <span class="criticality-badge ${getCritClass(avgCritBefore)}">
                                P:${avgProbBefore.toFixed(1)} × I:${avgImpactBefore.toFixed(1)} = ${avgCritBefore.toFixed(1)}
                            </span>
                        </td>
                        <td>
                            <span class="criticality-badge ${getCritClass(avgCritAfter)}">
                                P:${avgProbAfter.toFixed(1)} × I:${avgImpactAfter.toFixed(1)} = ${avgCritAfter.toFixed(1)}
                            </span>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
            });
        }
        
        // Ajouter un tableau pour les moyennes des groupes
        function updateGroupTable(groupBeforeData, groupAfterData) {
            // Récupérer le container dans la colonne droite
            const groupTableWrapper = document.getElementById('group-table-wrapper');
            if (!groupTableWrapper) {
                console.error('group-table-wrapper not found');
                return;
            }

            // Créer ou mettre à jour le tableau des groupes avec structure collapsable
            groupTableWrapper.innerHTML = `
                <div class="risk-table-container group-summary-table collapsible-section" style="margin-bottom: 8px;">
                    <h3 class="collapsible-header" onclick="toggleCollapse('group-summary-table-content')" style="margin-bottom: 8px;">
                        <span class="collapse-icon">▼</span>
                        Moyennes par Groupe
                    </h3>
                    <div id="group-summary-table-content" class="collapsible-content">
                        <div class="table-scroll-wrapper">
                            <table class="risk-table" style="table-layout: fixed;">
                                <thead>
                                    <tr>
                                        <th style="width: 90px;">Groupe</th>
                                        <th>Catégorie</th>
                                        <th style="width: 100px;">Avant</th>
                                        <th style="width: 100px;">Après</th>
                                    </tr>
                                </thead>
                                <tbody id="group-table-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            const groupTableBody = document.getElementById('group-table-body');
            
            riskGroups.forEach((group, index) => {
                const beforeData = groupBeforeData[index];
                const afterData = groupAfterData[index];
                
                // Utiliser les valeurs de base (sans jitter)
                const realXBefore = beforeData.baseX || beforeData.x;
                const realYBefore = beforeData.baseY || beforeData.y;
                const realXAfter = afterData.baseX || afterData.x;
                const realYAfter = afterData.baseY || afterData.y;
                
                // Calculer la criticité brute (P×I peut aller jusqu'à 16)
                const critBeforeRaw = realXBefore * realYBefore;
                const critAfterRaw = realXAfter * realYAfter;
                
                // Normaliser sur 5 : (criticité / 16) × 5
                const critBefore = (critBeforeRaw / 16) * 5;
                const critAfter = (critAfterRaw / 16) * 5;
                
                function getCritClass(crit) {
                    if (crit === 0) return 'criticality-low';
                    if (crit <= 1.25) return 'criticality-low';      // 0-4 sur 16 = 0-1.25 sur 5
                    if (crit <= 2.81) return 'criticality-medium';   // 5-9 sur 16 = 1.25-2.81 sur 5
                    if (crit <= 3.44) return 'criticality-high';     // 10-11 sur 16 = 3.12-3.44 sur 5
                    return 'criticality-critical';                    // 12-16 sur 16 = 3.75-5 sur 5
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="text-align: center; font-weight: 600; color: #1d1d1f; width: 90px;">${group.id}</td>
                    <td>
                        <div style="font-weight: 600; color: #1d1d1f; margin-bottom: 4px; line-height: 1.3;">${group.name}</div>
                        <div style="font-weight: 400; color: #5a5a5f; line-height: 1.4;">${group.description}</div>
                    </td>
                    <td style="text-align: center; width: 100px;">
                        <span class="criticality-badge ${getCritClass(critBefore)}" style="display: block;">
                            ${critBefore.toFixed(1)}/5
                        </span>
                    </td>
                    <td style="text-align: center; width: 100px;">
                        <span class="criticality-badge ${getCritClass(critAfter)}" style="display: block;">
                            ${critAfter.toFixed(1)}/5
                        </span>
                    </td>
                `;

                groupTableBody.appendChild(row);
            });

            // Restaurer l'état du collapse après génération du tableau
            const groupSummaryContent = document.getElementById('group-summary-table-content');
            const isCollapsed = localStorage.getItem('collapse-group-summary-table-content') === 'true';

            if (isCollapsed && groupSummaryContent) {
                const header = groupSummaryContent.previousElementSibling;
                header.classList.add('collapsed');
                groupSummaryContent.classList.add('collapsed');
            }
        }
        
        // Mettre à jour les graphiques
        function updateCharts() {
            const currentRisks = getCurrentRisks();
            
            // Fonction pour ajouter un décalage stratégique (pas aléatoire)
            // Pattern fixe pour éviter tout chevauchement
            function addStrategicOffset(value, groupIndex, isX) {
                const offsetPatterns = [
                    { x: -0.35, y: -0.35 },  // Pattern 1
                    { x: 0.35, y: -0.35 },   // Pattern 2
                    { x: -0.35, y: 0.35 },   // Pattern 3
                    { x: 0.35, y: 0.35 },    // Pattern 4
                    { x: 0, y: 0 }           // Pattern 5
                ];

                // Utiliser un pattern cyclique basé sur le modulo du nombre de patterns
                // Si on a plus de 5 groupes, on réutilise les patterns
                const patternIndex = groupIndex % offsetPatterns.length;
                const offset = isX ? offsetPatterns[patternIndex].x : offsetPatterns[patternIndex].y;
                return value + offset;
            }
            
            // Calculer les moyennes par groupe
            const groupBeforeData = riskGroups.map((group, groupIndex) => {
                let totalProbBefore = 0;
                let totalImpactBefore = 0;
                let count = 0;

                group.risks.forEach(risk => {
                    const currentRisk = currentRisks.find(r => r.id === risk.id);
                    if (currentRisk) {
                        // Ignorer les risques non évalués (valeur 0)
                        if (currentRisk.gcBefore[0] === 0 || currentRisk.gcBefore[1] === 0) {
                            return; // Skip ce risque
                        }

                        // Moyenne DTU et G&C
                        const avgProb = (currentRisk.dtuBefore[0] + currentRisk.gcBefore[0]) / 2;
                        const avgImpact = (currentRisk.dtuBefore[1] + currentRisk.gcBefore[1]) / 2;

                        totalProbBefore += avgProb;
                        totalImpactBefore += avgImpact;
                        count++;
                    }
                });

                const baseX = count > 0 ? totalProbBefore / count : 0;
                const baseY = count > 0 ? totalImpactBefore / count : 0;

                return {
                    x: addStrategicOffset(baseX, groupIndex, true),
                    y: addStrategicOffset(baseY, groupIndex, false),
                    baseX: baseX,
                    baseY: baseY,
                    label: `Groupe ${group.id}`,
                    groupName: group.name
                };
            });
            
            const groupAfterData = riskGroups.map((group, groupIndex) => {
                let totalProbAfter = 0;
                let totalImpactAfter = 0;
                let count = 0;

                group.risks.forEach(risk => {
                    const currentRisk = currentRisks.find(r => r.id === risk.id);
                    if (currentRisk) {
                        // Ignorer les risques non évalués (valeur 0)
                        if (currentRisk.gcAfter[0] === 0 || currentRisk.gcAfter[1] === 0) {
                            return; // Skip ce risque
                        }

                        // Moyenne DTU et G&C
                        const avgProb = (currentRisk.dtuAfter[0] + currentRisk.gcAfter[0]) / 2;
                        const avgImpact = (currentRisk.dtuAfter[1] + currentRisk.gcAfter[1]) / 2;

                        totalProbAfter += avgProb;
                        totalImpactAfter += avgImpact;
                        count++;
                    }
                });

                const baseX = count > 0 ? totalProbAfter / count : 0;
                const baseY = count > 0 ? totalImpactAfter / count : 0;

                return {
                    x: addStrategicOffset(baseX, groupIndex, true),
                    y: addStrategicOffset(baseY, groupIndex, false),
                    baseX: baseX,
                    baseY: baseY,
                    label: `Groupe ${group.id}`,
                    groupName: group.name
                };
            });
            
            // Filtrer les groupes sans risques évalués (ne pas afficher les points à 0,0)
            const filteredBeforeData = groupBeforeData.filter(group => group.baseX !== 0 || group.baseY !== 0);
            const filteredAfterData = groupAfterData.filter(group => group.baseX !== 0 || group.baseY !== 0);

            // Détruire les anciens graphiques
            if (chartBefore) chartBefore.destroy();
            if (chartAfter) chartAfter.destroy();

            // Créer les nouveaux graphiques
            chartBefore = createRiskChart(
                document.getElementById('chartBefore').getContext('2d'),
                filteredBeforeData,
                'Moyenne AVANT'
            );

            chartAfter = createRiskChart(
                document.getElementById('chartAfter').getContext('2d'),
                filteredAfterData,
                'Moyenne APRÈS'
            );
            
            updateRiskTable(currentRisks);
            updateGroupTable(groupBeforeData, groupAfterData);
            updateDashboard(currentRisks);
        }

        // ========================================
        // Mise à jour du Dashboard
        // ========================================
        function updateDashboard(currentRisks) {
            // Filtrer les risques évalués (criticité non nulle)
            const evaluatedRisks = currentRisks.filter(risk => {
                const critBefore = calculateCriticality(risk.gcBefore[0], risk.gcBefore[1]);
                return critBefore !== null;
            });

            // 1. Nombre total de risques évalués
            document.getElementById('dashboard-total-risks').textContent = evaluatedRisks.length;

            // 2. Risques critiques (score >= 10) avant et après
            const criticalBefore = evaluatedRisks.filter(risk => {
                const score = calculateCriticality(risk.gcBefore[0], risk.gcBefore[1]);
                return score !== null && score >= 10;
            }).length;

            const criticalAfter = evaluatedRisks.filter(risk => {
                const score = calculateCriticality(risk.gcAfter[0], risk.gcAfter[1]);
                return score !== null && score >= 10;
            }).length;

            document.getElementById('dashboard-critical-before').textContent = criticalBefore;
            document.getElementById('dashboard-critical-after').textContent = criticalAfter;

            // 3. Réduction moyenne du risque
            let totalReduction = 0;
            let countReduction = 0;

            evaluatedRisks.forEach(risk => {
                const reduction = calculateRiskReduction(
                    risk.gcBefore[0], risk.gcBefore[1],
                    risk.gcAfter[0], risk.gcAfter[1]
                );
                if (reduction !== null) {
                    totalReduction += reduction;
                    countReduction++;
                }
            });

            const avgReduction = countReduction > 0 ? Math.round(totalReduction / countReduction) : 0;
            const avgReductionEl = document.getElementById('dashboard-avg-reduction');
            avgReductionEl.textContent = `${avgReduction}%`;

            // Colorer selon la réduction
            if (avgReduction > 0) {
                avgReductionEl.style.color = '#1A6A3E'; // Vert
            } else if (avgReduction < 0) {
                avgReductionEl.style.color = '#A02828'; // Rouge
            } else {
                avgReductionEl.style.color = '#666666'; // Gris
            }

            // 4. Risques traités (statut "Traité" ou "Accepté")
            const treatedRisks = currentRisks.filter(risk => {
                return risk.statut === 'Traité' || risk.statut === 'Accepté';
            }).length;

            document.getElementById('dashboard-treated').textContent = `${treatedRisks}/${currentRisks.length}`;
        }

        // ========================================
        // Fonctions pour ajouter des groupes et des risques
        // ========================================

        window.addNewRiskToGroup = function(groupId) {
            const group = riskGroups.find(g => g.id == groupId);
            if (!group) {
                console.error(`❌ Groupe ${groupId} introuvable`);
                return;
            }

            // Créer un nouveau risque avec un ID unique
            const groupPrefix = `${groupId}.`;
            const maxNum = risks
                .filter(r => r.id.startsWith(groupPrefix))
                .map(r => parseInt(r.id.split('.')[1]))
                .reduce((max, num) => Math.max(max, num), 0);

            const newRiskId = `${groupId}.${maxNum + 1}`;

            // Créer le nouveau risque
            const newRisk = {
                id: newRiskId,
                title: "Nouveau risque",
                dtuBefore: [2, 2],
                dtuAfter: [1, 1],
                gcBefore: [2, 2],
                gcAfter: [1, 1],
                mesures: ["Remédiation à définir"]
            };

            // Ajouter au tableau global
            risks.push(newRisk);

            // Ajouter au groupe
            group.risks.push(newRisk);

            console.log(`✅ Nouveau risque ${newRiskId} ajouté au groupe ${groupId}`);

            // Re-render
            renderRisks();
            initGroupNameEditing();
            initGroupDescriptionEditing();
            initRiskTitleEditing();
            initRemediationEditing();
            initStatusDropdowns();
                initResponsableEditing();
            initSectionTitleEditing();
            updateCharts();
        }

        // ========================================
        // Modal d'agrandissement des matrices
        // ========================================

        let modalChartInstance = null;
        let currentMatrixType = 'before'; // 'before' ou 'after'

        function openMatrixModal(type) {
            currentMatrixType = type;
            const modal = document.getElementById('matrix-modal');
            const title = document.getElementById('matrix-modal-title');
            const canvas = document.getElementById('chartModal');

            // Déterminer le titre et les données
            if (type === 'before') {
                title.textContent = 'Matrice des risques non remédiés';
            } else {
                title.textContent = 'Matrice des risques remédiés';
            }

            // Afficher la modal
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            // Détruire l'ancien graphique s'il existe
            if (modalChartInstance) {
                modalChartInstance.destroy();
            }

            // Récupérer les données actuelles
            const currentRisks = getCurrentRisks();

            function addStrategicOffset(value, groupIndex, isX) {
                const offsetPatterns = [
                    { x: -0.35, y: -0.35 },
                    { x: 0.35, y: -0.35 },
                    { x: -0.35, y: 0.35 },
                    { x: 0.35, y: 0.35 },
                    { x: 0, y: 0 }
                ];
                const patternIndex = groupIndex % offsetPatterns.length;
                const offset = isX ? offsetPatterns[patternIndex].x : offsetPatterns[patternIndex].y;
                return value + offset;
            }

            const groupData = riskGroups.map((group, groupIndex) => {
                let totalProb = 0;
                let totalImpact = 0;
                let count = 0;

                group.risks.forEach(risk => {
                    const riskData = currentRisks.find(r => r.id === risk.id);
                    if (!riskData) return;

                    const prob = type === 'before' ? riskData.gcBefore[0] : riskData.gcAfter[0];
                    const impact = type === 'before' ? riskData.gcBefore[1] : riskData.gcAfter[1];

                    if (prob === 0 || impact === 0) return;

                    totalProb += prob;
                    totalImpact += impact;
                    count++;
                });

                if (count === 0) return null;

                const avgProb = totalProb / count;
                const avgImpact = totalImpact / count;

                return {
                    x: addStrategicOffset(avgProb, groupIndex, true),
                    y: addStrategicOffset(avgImpact, groupIndex, false),
                    baseX: avgProb,
                    baseY: avgImpact,
                    label: `Groupe ${group.id}`,
                    groupName: group.name
                };
            }).filter(d => d !== null);

            // Créer le graphique dans la modal
            modalChartInstance = new Chart(canvas, {
                type: 'scatter',
                data: {
                    datasets: [{
                        data: groupData,
                        backgroundColor: 'rgba(0, 122, 255, 0.8)',
                        borderColor: 'white',
                        borderWidth: 1.5,
                        pointRadius: 10,
                        pointHoverRadius: 12,
                        pointStyle: 'circle'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1,
                    animation: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleFont: { size: 13, weight: 'bold' },
                            bodyFont: { size: 12 },
                            padding: 10,
                            callbacks: {
                                title: function(context) {
                                    const point = context[0].raw;
                                    return point.label;
                                },
                                label: function(context) {
                                    const point = context.raw;
                                    const realX = point.baseX || point.x;
                                    const realY = point.baseY || point.y;
                                    const criticality = realX * realY;
                                    return [
                                        `${point.groupName}`,
                                        `Probabilité: ${realX.toFixed(2)}`,
                                        `Impact: ${realY.toFixed(2)}`,
                                        `Criticité: ${criticality.toFixed(1)}/16`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            min: 0.5,
                            max: 5.5,
                            ticks: {
                                stepSize: 1,
                                font: { size: 12 },
                                callback: function(value) {
                                    // Afficher seulement les valeurs entières 1-5
                                    return (value >= 1 && value <= 5 && Number.isInteger(value)) ? value : '';
                                }
                            },
                            grid: { display: false },
                            title: {
                                display: true,
                                text: 'Probabilité →',
                                font: { size: 12, weight: 'bold' }
                            }
                        },
                        y: {
                            min: 0.5,
                            max: 5.5,
                            ticks: {
                                stepSize: 1,
                                font: { size: 12 },
                                callback: function(value) {
                                    // Afficher seulement les valeurs entières 1-5
                                    return (value >= 1 && value <= 5 && Number.isInteger(value)) ? value : '';
                                }
                            },
                            grid: { display: false },
                            title: {
                                display: true,
                                text: '↑ Impact',
                                font: { size: 12, weight: 'bold' }
                            }
                        }
                    }
                },
                plugins: [matrixBackgroundPlugin, riskLabelsPlugin]
            });
        }

        function closeMatrixModal(event) {
            if (event) {
                // Empêcher la fermeture si on clique sur le contenu (pas le fond)
                if (event.target.closest('.matrix-modal-content') && !event.target.classList.contains('matrix-modal-close')) {
                    return;
                }
                event.stopPropagation();
            }

            const modal = document.getElementById('matrix-modal');
            modal.classList.remove('active');
            document.body.style.overflow = '';

            // Détruire le graphique pour libérer la mémoire
            if (modalChartInstance) {
                modalChartInstance.destroy();
                modalChartInstance = null;
            }
        }

        // Navigation entre les matrices (cycle)
        function navigateMatrix(direction) {
            if (direction === 'next') {
                // Cycle: before → after → before
                currentMatrixType = currentMatrixType === 'before' ? 'after' : 'before';
            } else {
                // Cycle: after → before → after
                currentMatrixType = currentMatrixType === 'after' ? 'before' : 'after';
            }
            openMatrixModal(currentMatrixType);
        }

        // Gestion du clavier pour la modal (Échap, flèches gauche/droite)
        document.addEventListener('keydown', function(e) {
            const modal = document.getElementById('matrix-modal');
            if (modal.classList.contains('active')) {
                if (e.key === 'Escape') {
                    closeMatrixModal();
                } else if (e.key === 'ArrowLeft') {
                    navigateMatrix('prev');
                } else if (e.key === 'ArrowRight') {
                    navigateMatrix('next');
                }
            }
        });


        // ========================================
        // Fonction pour changer de langue
        // ========================================

        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('riskr-language', lang);

            // Mettre à jour le sélecteur
            document.getElementById('language-selector').value = lang;

            // Mettre à jour tous les éléments avec data-i18n
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.textContent = t(key);
            });

            // Re-render les risques pour mettre à jour les dropdowns traduits
            renderRisks();
            initGroupNameEditing();
            initGroupDescriptionEditing();
            initRiskTitleEditing();
            initRemediationEditing();
            initStatusDropdowns();
            initResponsableEditing();
            initSectionTitleEditing();
            updateCharts();
        }

        function initLanguage() {
            const savedLang = localStorage.getItem('riskr-language') || 'fr';
            currentLanguage = savedLang;
            document.getElementById('language-selector').value = savedLang;
        }


        // Initialisation
        initLanguage(); // Initialiser la langue sauvegardée
        restoreGroupMappingFromStorage(); // Restaurer le mapping depuis localStorage (une seule fois)
        renderRisks();
        initGroupNameEditing(); // Activer l'édition inline sur les noms de groupes
        initGroupDescriptionEditing(); // Activer l'édition inline sur les descriptions de groupes
        initRiskTitleEditing(); // Activer l'édition inline sur les noms de risques
        initRemediationEditing(); // Activer l'édition inline sur les remédiations
        initStatusDropdowns();
                initResponsableEditing(); // Activer les dropdowns de statut
        initSectionTitleEditing(); // Activer l'édition inline sur les sous-titres de sections
        updateCharts();

        // Sauvegarder l'état initial pour le système undo/redo
        saveState();
    </script>
</body>
</html>
